<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>isoldier</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2016-12-27T14:49:37.150Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>isoldier</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>zookeeper介绍及集群部署</title>
    <link href="http://yoursite.com/2016/12/27/zookeeper%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://yoursite.com/2016/12/27/zookeeper介绍与安装部署/</id>
    <published>2016-12-27T07:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.150Z</updated>
    
    <content type="html"><![CDATA[<h2 id="zookeeper-介绍及集群部署"><a href="#zookeeper-介绍及集群部署" class="headerlink" title="zookeeper 介绍及集群部署"></a>zookeeper 介绍及集群部署</h2><h3 id="1-环境说明及，准备zookeeper安装包"><a href="#1-环境说明及，准备zookeeper安装包" class="headerlink" title="1. 环境说明及，准备zookeeper安装包"></a>1. 环境说明及，准备zookeeper安装包</h3><ul>
<li>安装环境</li>
</ul>
<p>本次安装环境是Vmware的虚拟机集群,系统版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">jinmeng@ubuntu:~$ lsb_release -a</div><div class="line">No LSB modules are available.</div><div class="line">Distributor ID:	Ubuntu</div><div class="line">Description:	Ubuntu 15.10</div><div class="line">Release:	15.10</div><div class="line">Codename:	wily</div></pre></td></tr></table></figure></p>
<p>三台虚拟机采用NAT网络方式，ip地址分别是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">192.168.24.110</div><div class="line">192.168.24.111</div><div class="line">192.168.24.112</div></pre></td></tr></table></figure></p>
<ul>
<li>zookeeper版本</li>
</ul>
<p>本次安装的版本是zookeeper-3.3.6.tar.gz</p>
<h3 id="2-常用配置参数概念"><a href="#2-常用配置参数概念" class="headerlink" title="2. 常用配置参数概念"></a>2. 常用配置参数概念</h3><ul>
<li><p>initLimit<br>这个配置项是用来配置 Zookeeper 接受客户端（这里所说的客户端不是用户连接 Zookeeper 服务器的客户端，而是 Zookeeper 服务器集群中连接到 Leader 的 Follower 服务器）初始化连接时最长能忍受多少个心跳时间间隔数。当已经超过 10 个心跳的时间（也就是 tickTime）长度后 Zookeeper 服务器还没有收到客户端的返回信息，那么表明这个客户端连接失败。总的时间长度就是 5*2000=10 秒</p>
</li>
<li><p>syncLimit<br>这个配置项标识 Leader 与 Follower 之间发送消息，请求和应答时间长度，最长不能超过多少个 tickTime 的时间长度，总的时间长度就是 2*2000=4 秒</p>
</li>
<li><p>server.A=B：C：D<br>其中 A 是一个数字，表示这个是第几号服务器；B 是这个服务器的 ip 地址；C 表示的是这个服务器与集群中的 Leader 服务器交换信息的端口；D 表示的是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的 Leader，而这个端口就是用来执行选举时服务器相互通信的端口。如果是伪集群的配置方式，由于 B 都是一样，所以不同的 Zookeeper 实例通信端口号不能一样，所以要给它们分配不同的端口号。</p>
</li>
<li><p>autopurge.snapRetainCount<br>自动清理snapshot 可以设置保留最近的snapshot的份数和清理的时间间隔<br>自动保留的份数参数，默认值是3，最小是3</p>
</li>
<li>autopurge.purgeInterval<br>自动清理的时间间隔，默认是0,也就是不自动清理，设置大于等于1的整数就可以启动自动清理</li>
<li>myid 除了修改 zoo.cfg 配置文件，集群模式下还要配置一个文件 myid，这个文件在 dataDir 目录下，这个文件里面就有一个数据就是 A 的值，注意，必须就是A的值，两者应该保持一致。否则启动不成功。Zookeeper 启动时会读取这个文件，拿到里面的数据与 zoo.cfg 里面的配置信息比较从而判断到底是那个 server。<h3 id="3-zookeeper安装部署"><a href="#3-zookeeper安装部署" class="headerlink" title="3. zookeeper安装部署"></a>3. zookeeper安装部署</h3></li>
<li>解压，设定zookeeper安装目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd ~/software</div><div class="line">tar -xvf  zookeeper-3.3.6.tar.gz</div></pre></td></tr></table></figure>
<ul>
<li>修改配置文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd zookeeper-3.3.6/conf/</div><div class="line">cp zoo_sample.cfg zoo.cfg</div><div class="line">vim zoo.cfg</div></pre></td></tr></table></figure>
</li>
</ul>
<p>修改配置文件为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># The number of milliseconds of each tick</div><div class="line">tickTime=2000</div><div class="line"># The number of ticks that the initial</div><div class="line"># synchronization phase can take</div><div class="line">initLimit=10</div><div class="line"># The number of ticks that can pass between</div><div class="line"># sending a request and getting an acknowledgement</div><div class="line">syncLimit=5</div><div class="line"># the directory where the snapshot is stored.</div><div class="line">dataDir=/home/jinmeng/software/zookeeper-3.3.6/data</div><div class="line">dataLogDir=/home/jinmeng/software/zookeeper-3.3.6/logs</div><div class="line"># the port at which the clients will connect</div><div class="line">clientPort=2181</div><div class="line">server.1=192.168.24.110:2888:3888  </div><div class="line">server.2=192.168.24.111:2888:3888  </div><div class="line">server.3=192.168.24.112:2888:3888</div></pre></td></tr></table></figure>
<ul>
<li><p>创建dataDir 和dataLogDir 目录,与上述配置文件中路径一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p zookeeper-3.3.6/logs</div><div class="line">mkdir -p zookeeper-3.3.6/data</div></pre></td></tr></table></figure>
</li>
<li><p>创建myid文件</p>
</li>
</ul>
<p>分别在三台机器上的data目录中创建myid文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd ~/software/zookeeper-3.3.6/data</div><div class="line">echo &quot;1&quot; &gt;myid #192.168.24.110</div><div class="line">#echo &quot;2&quot; &gt;myid #192.168.24.111</div><div class="line">#echo &quot;2&quot; &gt;myid #192.168.24.112</div></pre></td></tr></table></figure></p>
<h3 id="4-zookeeper启动"><a href="#4-zookeeper启动" class="headerlink" title="4. zookeeper启动"></a>4. zookeeper启动</h3><p>分别进入每台虚拟机的zookeeper-3.3.6的bin 目录,执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sh zkServer.sh start</div></pre></td></tr></table></figure>
<p>查看角色</p>
<p>192.168.24.110<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">jinmeng@ubuntu:~/software/zookeeper-3.3.6/bin$ sh zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/jinmeng/software/zookeeper-3.3.6/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div></pre></td></tr></table></figure></p>
<p>192.168.24.111<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">jinmeng@ubuntu-slave1:~/software/zookeeper-3.3.6/bin$ sh zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/jinmeng/software/zookeeper-3.3.6/bin/../conf/zoo.cfg</div><div class="line">Mode: leader</div></pre></td></tr></table></figure></p>
<p>192.168.24.112<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">jinmeng@ubuntu-slave2:~/software/zookeeper-3.3.6/bin$ sh zkServer.sh status</div><div class="line">JMX enabled by default</div><div class="line">Using config: /home/jinmeng/software/zookeeper-3.3.6/bin/../conf/zoo.cfg</div><div class="line">Mode: follower</div></pre></td></tr></table></figure></p>
<h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><p>问题描述<br>Ubuntu启动zookeeper时启动不成功， 报错信息显示启动脚本有问题,实际上是shell问题导致的</p>
<p>解决办法<br>jinmeng@ubuntu:~$ sudo dpkg-reconfigure dash<br>[sudo] password for jinmeng:<br>Package configuration</p>
<p> <img src="http://ww1.sinaimg.cn/large/97be9d10gw1fb5e73ci42j20sg08vq4t.jpg" alt=""><br>选择no<br>然后启动<br>jinmeng@ubuntu:~/app/zookeeper/zookeeper-3.4.6/bin$ sh zkServer.sh start<br>JMX enabled by default<br>Using config: /home/jinmeng/app/zookeeper/zookeeper-3.4.6/bin/../conf/zoo.cfg<br>Starting zookeeper … STARTED</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;zookeeper-介绍及集群部署&quot;&gt;&lt;a href=&quot;#zookeeper-介绍及集群部署&quot; class=&quot;headerlink&quot; title=&quot;zookeeper 介绍及集群部署&quot;&gt;&lt;/a&gt;zookeeper 介绍及集群部署&lt;/h2&gt;&lt;h3 id=&quot;1-环境说
    
    </summary>
    
      <category term="BigData" scheme="http://yoursite.com/categories/BigData/"/>
    
    
      <category term="zookeeper" scheme="http://yoursite.com/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>jstorm环境搭建及入门实例</title>
    <link href="http://yoursite.com/2016/12/26/jstorm%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>http://yoursite.com/2016/12/26/jstorm安装部署/</id>
    <published>2016-12-26T07:03:12.000Z</published>
    <updated>2016-12-27T14:49:37.089Z</updated>
    
    <content type="html"><![CDATA[<h3 id="jstrom-环境搭建及入门实例"><a href="#jstrom-环境搭建及入门实例" class="headerlink" title="jstrom 环境搭建及入门实例"></a>jstrom 环境搭建及入门实例</h3><h3 id="1-安装zookeeper"><a href="#1-安装zookeeper" class="headerlink" title="1. 安装zookeeper"></a>1. 安装zookeeper</h3><p>zookeeper的安装在这里不做介绍，可参考zookeeper安装相关文章，本文采用的单机安装部署</p>
<h3 id="2-安装Python"><a href="#2-安装Python" class="headerlink" title="2. 安装Python"></a>2. 安装Python</h3><p>一般机器中都自带Python，无需自己手动安装，检查自己的机器中是否有安装，没有则自己安装</p>
<h3 id="3-安装jdk"><a href="#3-安装jdk" class="headerlink" title="3. 安装jdk"></a>3. 安装jdk</h3><p>基本功，在此不做介绍</p>
<h3 id="4-安装jstorm"><a href="#4-安装jstorm" class="headerlink" title="4. 安装jstorm"></a>4. 安装jstorm</h3><p>以jstorm-2.1.1.zip为例,配置环境变量</p>
<pre><code>unzip jstorm-2.1.1.zip
vi ~/.bashrc
export JSTORM_HOME=/XXXXX/XXXX
export PATH=$PATH:$JSTORM_HOME/bin
</code></pre><p>配置$JSTORM_HOME/conf/storm.yaml</p>
<p>配置项：</p>
<ul>
<li>storm.zookeeper.servers: 表示zookeeper 的地址，</li>
<li>nimbus.host: 表示nimbus的地址</li>
<li>storm.zookeeper.root: 表示JStorm在zookeeper中的根目录，当多个JStorm共享一个zookeeper时，需要设置该选项，默认即为“/jstorm”</li>
<li>storm.local.dir: 表示JStorm临时数据存放目录，需要保证JStorm程序对该目录有写权限</li>
<li>java.library.path: Zeromq 和java zeromq library的安装目录，默认”/usr/local/lib:/opt/local/lib:/usr/lib”</li>
<li>supervisor.slots.ports: 表示Supervisor 提供的端口Slot列表，注意不要和其他端口发生冲突，默认是68xx，而Storm的是67xx</li>
<li>topology.enable.classloader: false, 默认关闭classloader，如果应用的jar与JStorm的依赖的jar发生冲突，比如应用使用thrift9，但jstorm使用thrift7时，就需要打开classloader。建议在集群级别上默认关闭，在具体需要隔离的topology上打开这个选项。</li>
</ul>
<p>放上一个自己配置配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">########### These MUST be filled in for a storm configuration</div><div class="line"> storm.zookeeper.servers:</div><div class="line">     - &quot;192.168.24.128&quot;</div><div class="line"> storm.zookeeper.ports: 2181</div><div class="line"> storm.zookeeper.root: &quot;/jstorm&quot;</div><div class="line"></div><div class="line"> cluster.name: &quot;vm-jstorm&quot;</div><div class="line"></div><div class="line">#nimbus.host/nimbus.host.start.supervisor is being used by $JSTORM_HOME/bin/start.sh</div><div class="line">#it only support IP, please don&apos;t set hostname</div><div class="line"># For example</div><div class="line"># nimbus.host: &quot;10.132.168.10, 10.132.168.45&quot;</div><div class="line"> nimbus.host: &quot;192.168.24.128&quot;</div><div class="line">#nimbus.host.start.supervisor: false</div><div class="line"></div><div class="line"># %JSTORM_HOME% is the jstorm home directory</div><div class="line"> storm.local.dir: &quot;%JSTORM_HOME%/data&quot;</div><div class="line"># storm.local.dir: &quot;/home/jinmeng/app/jstorm-2.1.1/data&quot;</div><div class="line"># please set absolute path, default path is JSTORM_HOME/logs</div><div class="line"># jstorm.log.dir: &quot;/home/jinmeng/app/jstorm-2.1.1/logs&quot;</div><div class="line"> jstorm.log.dir: &quot;%JSTORM_HOME%/app/logs&quot;</div><div class="line"># java.library.path: &quot;/usr/local/lib:/opt/local/lib:/usr/lib&quot;</div><div class="line"></div><div class="line"></div><div class="line"># if supervisor.slots.ports is null,</div><div class="line"># the port list will be generated by cpu cores and system memory size</div><div class="line"># for example,</div><div class="line"># there are cpu_num = system_physical_cpu_num/supervisor.slots.port.cpu.weight</div><div class="line"># there are mem_num = system_physical_memory_size/(worker.memory.size * supervisor.slots.port.mem.weight)</div><div class="line"># The final port number is min(cpu_num, mem_num)</div><div class="line"># supervisor.slots.ports.base: 6800</div><div class="line"># supervisor.slots.port.cpu.weight: 1.2</div><div class="line"># supervisor.slots.port.mem.weight: 0.7</div><div class="line"># supervisor.slots.ports: null</div><div class="line"> supervisor.slots.ports:</div><div class="line">     - 6800</div><div class="line">     - 6801</div><div class="line">     - 6802</div><div class="line">     - 6803</div><div class="line"></div><div class="line"># Default disable user-define classloader</div><div class="line"># If there are jar conflict between jstorm and application,</div><div class="line"># please enable it</div><div class="line"># topology.enable.classloader: false</div><div class="line"></div><div class="line"># enable supervisor use cgroup to make resource isolation</div><div class="line"># Before enable it, you should make sure:</div><div class="line">#       1. Linux version (&gt;= 2.6.18)</div><div class="line">#       2. Have installed cgroup (check the file&apos;s existence:/proc/cgroups)</div><div class="line">#       3. You should start your supervisor on root</div><div class="line"># You can get more about cgroup:</div><div class="line">#   http://t.cn/8s7nexU</div><div class="line"># supervisor.enable.cgroup: false</div><div class="line"></div><div class="line"></div><div class="line">### Netty will send multiple messages in one batch  </div><div class="line">### Setting true will improve throughput, but more latency</div><div class="line"># storm.messaging.netty.transfer.async.batch: true</div><div class="line"></div><div class="line">### if this setting  is true, it will use disruptor as internal queue, which size is limited</div><div class="line">### otherwise, it will use LinkedBlockingDeque as internal queue , which size is unlimited</div><div class="line">### generally when this setting is true, the topology will be more stable,</div><div class="line">### but when there is a data loop flow, for example A -&gt; B -&gt; C -&gt; A</div><div class="line">### and the data flow occur blocking, please set this as false</div><div class="line"># topology.buffer.size.limited: true</div><div class="line"></div><div class="line">### default worker memory size, unit is byte default 2G</div><div class="line">#  worker.memory.size: 2147483648</div><div class="line"> worker.memory.size: 536870912</div><div class="line"></div><div class="line"># Metrics Monitor</div><div class="line"># topology.performance.metrics: it is the switch flag for performance</div><div class="line"># purpose. When it is disabled, the data of timer and histogram metrics</div><div class="line"># will not be collected.</div><div class="line"># topology.alimonitor.metrics.post: If it is disable, metrics data</div><div class="line"># will only be printed to log. If it is enabled, the metrics data will be</div><div class="line"># posted to alimonitor besides printing to log.</div><div class="line"># topology.performance.metrics: true</div><div class="line"># topology.alimonitor.metrics.post: false</div><div class="line"></div><div class="line"># UI MultiCluster</div><div class="line"># Following is an example of multicluster UI configuration</div><div class="line"> ui.clusters:</div><div class="line">    - &#123;</div><div class="line">        name: &quot;vm-jstorm&quot;,</div><div class="line">        zkRoot: &quot;/jstorm&quot;,</div><div class="line">        zkServers:</div><div class="line">             [&quot;192.168.24.128&quot;],</div><div class="line">        zkPort: 2181,</div><div class="line">      &#125;</div></pre></td></tr></table></figure></p>
<p>在提交jar的节点上执行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#mkdir ~/.jstorm</div><div class="line">#cp -f $JSTORM_HOME/conf/storm.yaml ~/.jstorm</div></pre></td></tr></table></figure></p>
<h3 id="4-安装jstorm-UI"><a href="#4-安装jstorm-UI" class="headerlink" title="4. 安装jstorm UI"></a>4. 安装jstorm UI</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">mkdir ~/.jstorm</div><div class="line">cp -f $JSTORM_HOME/conf/storm.yaml ~/.jstorm</div><div class="line">下载tomcat 7.x （以apache-tomcat-7.0.37 为例）</div><div class="line">tar -xzf apache-tomcat-7.0.37.tar.gz</div><div class="line">cd apache-tomcat-7.0.37</div><div class="line">cd webapps</div><div class="line">cp $JSTORM_HOME/jstorm-ui-2.1.1.war ./</div><div class="line">mv ROOT ROOT.old</div><div class="line">ln -s jstorm-ui-2.1.1 ROOT           这个地方可能变化，是根据你的JStorm版本来确定，比如当2.1.1时，是ln -s jstorm-2.1.1 ROOT</div><div class="line">另外不是 ln -s jstorm-ui-2.1.1.war ROOT 这个要小心</div><div class="line">cd ../bin</div><div class="line">./startup.sh</div></pre></td></tr></table></figure>
<h3 id="4-jstrom入门实例"><a href="#4-jstrom入门实例" class="headerlink" title="4. jstrom入门实例"></a>4. jstrom入门实例</h3><p>一个统计jstorm的word-count实例，详见</p>
<blockquote>
<p>github word count工程<br><a href="https://github.com/iisoldier/jstorm.git" target="_blank" rel="external">https://github.com/iisoldier/jstorm.git</a></p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;jstrom-环境搭建及入门实例&quot;&gt;&lt;a href=&quot;#jstrom-环境搭建及入门实例&quot; class=&quot;headerlink&quot; title=&quot;jstrom 环境搭建及入门实例&quot;&gt;&lt;/a&gt;jstrom 环境搭建及入门实例&lt;/h3&gt;&lt;h3 id=&quot;1-安装zooke
    
    </summary>
    
      <category term="jstorm" scheme="http://yoursite.com/categories/jstorm/"/>
    
    
      <category term="jstorm" scheme="http://yoursite.com/tags/jstorm/"/>
    
  </entry>
  
  <entry>
    <title>使用atom来实现线程安全</title>
    <link href="http://yoursite.com/2016/12/23/atom%E5%8E%9F%E5%AD%90%E6%80%A7/"/>
    <id>http://yoursite.com/2016/12/23/atom原子性/</id>
    <published>2016-12-23T13:43:12.000Z</published>
    <updated>2016-12-27T14:49:36.988Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用atom来实现线程安全"><a href="#使用atom来实现线程安全" class="headerlink" title="使用atom来实现线程安全"></a>使用atom来实现线程安全</h2><h3 id="Atom概念"><a href="#Atom概念" class="headerlink" title="Atom概念"></a>Atom概念</h3><p>原子就是不可再分割的意思，在java中可以使用原子性操作来保证操作的唯一性从而保证线程安全,</p>
<h3 id="直接上使用demo"><a href="#直接上使用demo" class="headerlink" title="直接上使用demo"></a>直接上使用demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.concurrent.atom;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 原子操作，保证线程安全的实例</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> isoldier</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomDemo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> AtomicInteger atomicI = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> i = <span class="number">0</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">final</span> AtomDemo cas = <span class="keyword">new</span> AtomDemo();</div><div class="line">		List&lt;Thread&gt; ts = <span class="keyword">new</span> ArrayList&lt;Thread&gt;(<span class="number">600</span>);</div><div class="line">		<span class="keyword">long</span> start = System.currentTimeMillis();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">100</span>; j++) &#123;</div><div class="line">			Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">					<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</div><div class="line">						cas.count();</div><div class="line">						cas.safeCount();</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">			ts.add(t);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (Thread t : ts) &#123;</div><div class="line">			t.start();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 等待所有线程执行完成</span></div><div class="line">		<span class="keyword">for</span> (Thread t : ts) &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				t.join();</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		System.out.println(cas.i);</div><div class="line">		System.out.println(cas.atomicI.get());</div><div class="line">		System.out.println(System.currentTimeMillis() - start);</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 使用CAS实现线程安全计数器</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">safeCount</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">for</span> (;;) &#123;</div><div class="line">			<span class="keyword">int</span> i = atomicI.get();</div><div class="line">			<span class="keyword">boolean</span> suc = atomicI.compareAndSet(i, ++i);</div><div class="line">			<span class="keyword">if</span> (suc) &#123;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 非线程安全计数器</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">count</span><span class="params">()</span> </span>&#123;</div><div class="line">		i++;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">995610</div><div class="line">1000000</div><div class="line">85</div></pre></td></tr></table></figure></p>
<p>从结果中可以看出在线程不安全的情况下100000次计算的结果少了4000+</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;使用atom来实现线程安全&quot;&gt;&lt;a href=&quot;#使用atom来实现线程安全&quot; class=&quot;headerlink&quot; title=&quot;使用atom来实现线程安全&quot;&gt;&lt;/a&gt;使用atom来实现线程安全&lt;/h2&gt;&lt;h3 id=&quot;Atom概念&quot;&gt;&lt;a href=&quot;#Ato
    
    </summary>
    
      <category term="多线程" scheme="http://yoursite.com/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
    
      <category term="多线程" scheme="http://yoursite.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>一致性hash算法</title>
    <link href="http://yoursite.com/2016/12/23/%E4%B8%80%E8%87%B4%E6%80%A7hash%E7%AE%97%E6%B3%95/"/>
    <id>http://yoursite.com/2016/12/23/一致性hash算法/</id>
    <published>2016-12-23T13:10:12.000Z</published>
    <updated>2016-12-27T14:49:37.176Z</updated>
    
    <content type="html"><![CDATA[<h2 id="一致性hash算法"><a href="#一致性hash算法" class="headerlink" title="一致性hash算法"></a>一致性hash算法</h2><h3 id="0-背景"><a href="#0-背景" class="headerlink" title="0. 背景"></a>0. 背景</h3><p>最近在看一本书大型网站的架构，在看到分布式缓存的章节是提到了一致性hash问题来实现分布式缓存服务，这个概念在之前也听过但是没有去怎么理解，，正好趁此机会看一下</p>
<h3 id="1-概念介绍"><a href="#1-概念介绍" class="headerlink" title="1. 概念介绍"></a>1. 概念介绍</h3><ul>
<li>普通hash取摸方式的弊端</li>
</ul>
<p>普通的hash取模的方式有一些弊端,比如集群中可用机器适量为N，那么key值为K的的数据请求很简单的应该路由到hash(K) mod N对应的机器。随着系统访问压力的增长，缓存系统不得不通过增加机器节点的方式提高集群的相应速度和数据承载量。增加机器意味着按照hash取模的方式，在增加机器节点的这一时刻，大量的缓存命不中，缓存数据需要重新建立，甚至是进行整体的缓存数据迁移，瞬间会给DB带来极高的系统负载，设置导致DB服务器宕机。严重影响网站的伸缩性。</p>
<ul>
<li>一致性hash原理介绍</li>
</ul>
<p>一致性哈希算法(Consistent Hashing Algorithm)是一种分布式算法，常用于负载均衡。Memcached client也选择这种算法。</p>
<p>简单来说，一致性哈希将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数H的值空间为0 - (2^32)-1（即哈希值是一个32位无符号整形）。整个空间按顺时针方向组织。0和(2^32)-1在零点中方向重合。下一步将各个服务器使用H进行一个哈希，具体可以选择服务器的ip或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。</p>
<ul>
<li>虚拟节点解决数据倾斜问题</li>
</ul>
<p>接下来使用如下算法定位数据访问到相应服务器：将数据key使用相同的函数H计算出哈希值h，通根据h确定此数据在环上的位置，从此位置沿环顺时针“行走”，第一台遇到的服务器就是其应该定位到的服务器。但是在服务器数量很少的情况下，容易出现数据倾斜的问题 ，这是我们可以采用虚拟节点的方式，让服务器看起来均匀的分布在整个hash环上</p>
<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.hash;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.security.MessageDigest;</div><div class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</div><div class="line"><span class="keyword">import</span> java.util.Collection;</div><div class="line"><span class="keyword">import</span> java.util.SortedMap;</div><div class="line"><span class="keyword">import</span> java.util.TreeMap;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 一致性Hash算法</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> &lt;T&gt; 节点类型</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsistentHash</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Hash计算对象，用于自定义hash算法</div><div class="line">     */</div><div class="line">    HashFunc hashFunc;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> numberOfReplicas;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 一致性Hash环</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SortedMap&lt;Long, T&gt; circle = <span class="keyword">new</span> TreeMap&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 构造，使用Java默认的Hash算法</div><div class="line">     * <span class="doctag">@param</span> numberOfReplicas 复制的节点个数，增加每个节点的复制节点有利于负载均衡</div><div class="line">     * <span class="doctag">@param</span> nodes            节点对象</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsistentHash</span><span class="params">(<span class="keyword">int</span> numberOfReplicas, Collection&lt;T&gt; nodes)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.numberOfReplicas = numberOfReplicas;</div><div class="line">        <span class="keyword">this</span>.hashFunc = <span class="keyword">new</span> HashFunc() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Long <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line"><span class="comment">//                return fnv1HashingAlg(key.toString());</span></div><div class="line">                <span class="keyword">return</span> md5HashingAlg(key.toString());</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        <span class="comment">//初始化节点</span></div><div class="line">        <span class="keyword">for</span> (T node : nodes) &#123;</div><div class="line">            add(node);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 构造</div><div class="line">     * <span class="doctag">@param</span> hashFunc         hash算法对象</div><div class="line">     * <span class="doctag">@param</span> numberOfReplicas 复制的节点个数，增加每个节点的复制节点有利于负载均衡</div><div class="line">     * <span class="doctag">@param</span> nodes            节点对象</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsistentHash</span><span class="params">(HashFunc hashFunc, <span class="keyword">int</span> numberOfReplicas, Collection&lt;T&gt; nodes)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.numberOfReplicas = numberOfReplicas;</div><div class="line">        <span class="keyword">this</span>.hashFunc = hashFunc;</div><div class="line">        <span class="comment">//初始化节点</span></div><div class="line">        <span class="keyword">for</span> (T node : nodes) &#123;</div><div class="line">            add(node);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 增加节点&lt;br&gt;</div><div class="line">     * 每增加一个节点，就会在闭环上增加给定复制节点数&lt;br&gt;</div><div class="line">     * 例如复制节点数是2，则每调用此方法一次，增加两个虚拟节点，这两个节点指向同一Node</div><div class="line">     * 由于hash算法会调用node的toString方法，故按照toString去重</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> node 节点对象</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(T node)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numberOfReplicas; i++) &#123;</div><div class="line">            circle.put(hashFunc.hash(node.toString() + i), node);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 移除节点的同时移除相应的虚拟节点</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> node 节点对象</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(T node)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numberOfReplicas; i++) &#123;</div><div class="line">            circle.remove(hashFunc.hash(node.toString() + i));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获得一个最近的顺时针节点</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> key 为给定键取Hash，取得顺时针方向上最近的一个虚拟节点对应的实际节点</div><div class="line">     * <span class="doctag">@return</span> 节点对象</div><div class="line">     *</div><div class="line">     * * 关于tailMap 函数的说明  返回此映射的部分视图，其键大于等于 hash</div><div class="line">     * Returns a view of the portion of this map whose keys are</div><div class="line">     * greater than or equal to &#123;<span class="doctag">@code</span> fromKey&#125;.  The returned map is</div><div class="line">     * backed by this map, so changes in the returned map are</div><div class="line">     * reflected in this map, and vice-versa.  The returned map</div><div class="line">     * supports all optional map operations that this map supports.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (circle.isEmpty()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">long</span> hash = hashFunc.hash(key);</div><div class="line">        <span class="keyword">if</span> (!circle.containsKey(hash)) &#123;</div><div class="line">            SortedMap&lt;Long, T&gt; tailMap = circle.tailMap(hash);</div><div class="line">            hash = tailMap.isEmpty() ? circle.firstKey() : tailMap.firstKey();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//正好命中</span></div><div class="line">        <span class="keyword">return</span> circle.get(hash);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 使用MD5算法</div><div class="line">     * <span class="doctag">@param</span> key</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">md5HashingAlg</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        MessageDigest md5 = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            md5 = MessageDigest.getInstance(<span class="string">"MD5"</span>);</div><div class="line">            md5.reset();</div><div class="line">            md5.update(key.getBytes());</div><div class="line">            <span class="keyword">byte</span>[] bKey = md5.digest();</div><div class="line">            <span class="keyword">long</span> res = ((<span class="keyword">long</span>) (bKey[<span class="number">3</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">24</span>) | ((<span class="keyword">long</span>) (bKey[<span class="number">2</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">16</span>) | ((<span class="keyword">long</span>) (bKey[<span class="number">1</span>] &amp; <span class="number">0xFF</span>) &lt;&lt; <span class="number">8</span>)| (<span class="keyword">long</span>) (bKey[<span class="number">0</span>] &amp; <span class="number">0xFF</span>);</div><div class="line">            <span class="keyword">return</span> res;</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="number">0l</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 使用FNV1hash算法</div><div class="line">     * <span class="doctag">@param</span> key</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unused"</span>)</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">fnv1HashingAlg</span><span class="params">(String key)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> p = <span class="number">16777619</span>;</div><div class="line">        <span class="keyword">int</span> hash = (<span class="keyword">int</span>) <span class="number">2166136261L</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; key.length(); i++)</div><div class="line">            hash = (hash ^ key.charAt(i)) * p;</div><div class="line">        hash += hash &lt;&lt; <span class="number">13</span>;</div><div class="line">        hash ^= hash &gt;&gt; <span class="number">7</span>;</div><div class="line">        hash += hash &lt;&lt; <span class="number">3</span>;</div><div class="line">        hash ^= hash &gt;&gt; <span class="number">17</span>;</div><div class="line">        hash += hash &lt;&lt; <span class="number">5</span>;</div><div class="line">        <span class="keyword">return</span> hash;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Hash算法对象，用于自定义hash算法</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HashFunc</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">hash</span><span class="params">(Object key)</span></span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;一致性hash算法&quot;&gt;&lt;a href=&quot;#一致性hash算法&quot; class=&quot;headerlink&quot; title=&quot;一致性hash算法&quot;&gt;&lt;/a&gt;一致性hash算法&lt;/h2&gt;&lt;h3 id=&quot;0-背景&quot;&gt;&lt;a href=&quot;#0-背景&quot; class=&quot;headerli
    
    </summary>
    
      <category term="algorithm" scheme="http://yoursite.com/categories/algorithm/"/>
    
    
      <category term="algorithm" scheme="http://yoursite.com/tags/algorithm/"/>
    
  </entry>
  
  <entry>
    <title>java读取文件的方式</title>
    <link href="http://yoursite.com/2016/12/23/java%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E5%BC%8F/"/>
    <id>http://yoursite.com/2016/12/23/java读取文件的方式/</id>
    <published>2016-12-23T12:43:12.000Z</published>
    <updated>2016-12-27T14:49:37.058Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Java如何读取文件"><a href="#Java如何读取文件" class="headerlink" title="Java如何读取文件"></a>Java如何读取文件</h2><h3 id="0-背景"><a href="#0-背景" class="headerlink" title="0. 背景"></a>0. 背景</h3><p>今天在打算运行jstorm中wordcount的例子，需要读取一个文本，这个时候遇到了一个小问题在此记录一下就是如何读取文件的路径。</p>
<h3 id="1-两种方式"><a href="#1-两种方式" class="headerlink" title="1. 两种方式"></a>1. 两种方式</h3><ul>
<li>class.getResource(String filepath)</li>
<li>class.getClassLoader().getResource(String filepath)<h3 id="2-demo"><a href="#2-demo" class="headerlink" title="2. demo"></a>2. demo</h3>标准的maven项目结构，文本文件放在src/main/resources目录下</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.guava.fileIO;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.File;</div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.common.base.Charsets;</div><div class="line"><span class="keyword">import</span> com.google.common.collect.ImmutableList;</div><div class="line"><span class="keyword">import</span> com.google.common.io.Files;</div><div class="line"><span class="keyword">import</span> com.google.common.io.LineProcessor;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadFile</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 普通的读取文件的方法，主要针对一些较小的文件。 推荐使用方法，因为我们平时需要读取的都是很小的文件。</div><div class="line">	 *</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">readFile</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="comment">// 首先获取文件所在路径</span></div><div class="line">		<span class="comment">// /D:/EclipseWorkspace/BasicLearning/Guava/target/classes/readfile.txt</span></div><div class="line">		<span class="comment">/**</span></div><div class="line">		 * 方式一:ReadFile.class.getResource();</div><div class="line">		 */</div><div class="line"><span class="comment">//		String filepath = ReadFile.class.getResource("/readfile.txt").getPath();</span></div><div class="line"></div><div class="line">		<span class="comment">/**</span></div><div class="line">		 * 方式1-1：如果文件名不加"/" 那么久要求该文件在这个类所在的package下</div><div class="line"> 		 */</div><div class="line">		String filepath = ReadFile.class.getResource(<span class="string">"readfile.txt"</span>).getPath();</div><div class="line">		<span class="comment">/**</span></div><div class="line">		 * 方式二：ReadFile.class.getClassLoader().getResource()</div><div class="line">		 */</div><div class="line"><span class="comment">//		String filepath = ReadFile.class.getClassLoader().getResource("readfile.txt").getPath();</span></div><div class="line"></div><div class="line">		<span class="comment">/**</span></div><div class="line">		 * 方式三：ClassLoader.getSystemResource("readfile.txt")</div><div class="line">		 */</div><div class="line"><span class="comment">//		String filepath = ClassLoader.getSystemResource("readfile.txt").getPath();</span></div><div class="line"></div><div class="line"></div><div class="line">		System.out.println(filepath);</div><div class="line"></div><div class="line"></div><div class="line">		File file = <span class="keyword">new</span> File(filepath);</div><div class="line">		List&lt;String&gt; lines = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			lines = Files.asCharSource(file, Charsets.UTF_8).readLines();</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		ImmutableList&lt;String&gt; filelines = ImmutableList.copyOf(lines);</div><div class="line">		<span class="keyword">for</span> (String line : filelines) &#123;</div><div class="line">			System.out.println(line);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="简单总结"><a href="#简单总结" class="headerlink" title="简单总结"></a>简单总结</h3><p>由于现在使用的普遍是maven项目，<br>所以当我们使用</p>
<ul>
<li><p>class.getResource(String filepath)</p>
<p>filepath 要以/开头</p>
</li>
<li><p>class.getClassLoader().getResource(String filepath)</p>
<p>filepath 不以/开头</p>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Java如何读取文件&quot;&gt;&lt;a href=&quot;#Java如何读取文件&quot; class=&quot;headerlink&quot; title=&quot;Java如何读取文件&quot;&gt;&lt;/a&gt;Java如何读取文件&lt;/h2&gt;&lt;h3 id=&quot;0-背景&quot;&gt;&lt;a href=&quot;#0-背景&quot; class=&quot;head
    
    </summary>
    
      <category term="java" scheme="http://yoursite.com/categories/java/"/>
    
    
      <category term="java" scheme="http://yoursite.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>ConcurrentHashMap简单使用</title>
    <link href="http://yoursite.com/2016/12/23/ConcurrentHashMap%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2016/12/23/ConcurrentHashMap简单使用/</id>
    <published>2016-12-22T16:58:10.000Z</published>
    <updated>2016-12-27T14:49:37.007Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ConcurrentHashMap简单使用"><a href="#ConcurrentHashMap简单使用" class="headerlink" title="ConcurrentHashMap简单使用"></a>ConcurrentHashMap简单使用</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><h4 id="线程不安全的HashMap"><a href="#线程不安全的HashMap" class="headerlink" title="线程不安全的HashMap"></a>线程不安全的HashMap</h4><p>因为多线程环境下，使用HashMap进行put操作会引起死循环，导致CPU利用率接近100%，所以在并发情况下不能使用HashMap，如以下代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;(<span class="number">2</span>);</div><div class="line">Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</div><div class="line">            <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    map.put(UUID.randomUUID().toString(), <span class="string">""</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;, <span class="string">"ftf"</span> + i).start();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;, <span class="string">"ftf"</span>);</div><div class="line">t.start();</div><div class="line">t.join();</div></pre></td></tr></table></figure></p>
<h4 id="效率低下的HashTable容器"><a href="#效率低下的HashTable容器" class="headerlink" title="效率低下的HashTable容器"></a>效率低下的HashTable容器</h4><p>HashTable容器使用synchronized来保证线程安全，但在线程竞争激烈的情况下HashTable的效率非常低下。因为当一个线程访问HashTable的同步方法时，其他线程访问HashTable的同步方法时，可能会进入阻塞或轮询状态。如线程1使用put进行添加元素，线程2不但不能使用put方法添加元素，并且也不能使用get方法来获取元素，所以竞争越激烈效率越低。</p>
<h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><h4 id="锁分段技术"><a href="#锁分段技术" class="headerlink" title="锁分段技术"></a>锁分段技术</h4><p>HashTable容器在竞争激烈的并发环境下表现出效率低下的原因是所有访问HashTable的线程都必须竞争同一把锁，那假如容器里有多把锁，每一把锁用于锁容器其中一部分数据，那么当多线程访问容器里不同数据段的数据时，线程间就不会存在锁竞争，从而可以有效的提高并发访问效率，这就是ConcurrentHashMap所使用的锁分段技术，首先将数据分成一段一段的存储，然后给每一段数据配一把锁，当一个线程占用锁访问其中一个段数据的时候，其他段的数据也能被其他线程访问。</p>
<h4 id="ConcurrentHashMap的结构"><a href="#ConcurrentHashMap的结构" class="headerlink" title="ConcurrentHashMap的结构"></a>ConcurrentHashMap的结构</h4><p>我们通过ConcurrentHashMap的类图来分析ConcurrentHashMap的结构。<br><img src="http://ww3.sinaimg.cn/large/97be9d10gw1fazv2tz365j20dw0bkq3n.jpg" alt=""><br>ConcurrentHashMap是由Segment数组结构和HashEntry数组结构组成。Segment是一种可重入锁ReentrantLock，在ConcurrentHashMap里扮演锁的角色，HashEntry则用于存储键值对数据。一个ConcurrentHashMap里包含一个Segment数组，Segment的结构和HashMap类似，是一种数组和链表结构， 一个Segment里包含一个HashEntry数组，每个HashEntry是一个链表结构的元素， 每个Segment守护者一个HashEntry数组里的元素,当对HashEntry数组的数据进行修改时，必须首先获得它对应的Segment锁。Segment的大小是2的N次方<br><img src="http://ww1.sinaimg.cn/large/97be9d10gw1fazv44onovj20dw0733z4.jpg" alt=""></p>
<h3 id="使用demo"><a href="#使用demo" class="headerlink" title="使用demo"></a>使用demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.concurrent.concurrenthashmap;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ConcurrentHashMap;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMapDemo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"></div><div class="line">		ConcurrentHashMap&lt;String, String&gt; StringCapitalMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, String&gt;();</div><div class="line">		StringCapitalMap.put(<span class="string">"india"</span>, <span class="string">"Delhi"</span>);</div><div class="line">		StringCapitalMap.put(<span class="string">"japan"</span>, <span class="string">"Tokyo"</span>);</div><div class="line">		StringCapitalMap.put(<span class="string">"france"</span>, <span class="string">"Paris"</span>);</div><div class="line">		StringCapitalMap.put(<span class="string">"russia"</span>, <span class="string">"Moscow"</span>);</div><div class="line"></div><div class="line">		Iterator&lt;String&gt; StringCapitalIter = StringCapitalMap.keySet().iterator();<span class="comment">// put debug point at this line</span></div><div class="line">		<span class="keyword">while</span> (StringCapitalIter.hasNext()) &#123;</div><div class="line">			String StringObj = StringCapitalIter.next();</div><div class="line">			String capital = StringCapitalMap.get(StringObj);</div><div class="line">			System.out.println(StringObj+<span class="string">"---"</span> + capital);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ConcurrentHashMap简单使用&quot;&gt;&lt;a href=&quot;#ConcurrentHashMap简单使用&quot; class=&quot;headerlink&quot; title=&quot;ConcurrentHashMap简单使用&quot;&gt;&lt;/a&gt;ConcurrentHashMap简单使用&lt;/
    
    </summary>
    
      <category term="多线程" scheme="http://yoursite.com/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
    
      <category term="多线程" scheme="http://yoursite.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>BlockingQueue的使用</title>
    <link href="http://yoursite.com/2016/12/23/BlockingQueue%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2016/12/23/BlockingQueue使用/</id>
    <published>2016-12-22T16:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="BlockingQueue的使用"><a href="#BlockingQueue的使用" class="headerlink" title="BlockingQueue的使用"></a>BlockingQueue的使用</h2><h3 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h3><p>阻塞队列（BlockingQueue）是一个支持两个附加操作的队列。这两个附加的操作是：在队列为空时，获取元素的线程会等待队列变为非空。当队列满时，存储元素的线程会等待队列可用。阻塞队列常用于生产者和消费者的场景，生产者是往队列里添加元素的线程，消费者是从队列里拿元素的线程。阻塞队列就是生产者存放元素的容器，而消费者也只从容器里拿元素。</p>
<p>四种处理方法汇总</p>
<table>
<thead>
<tr>
<th>方法\处理方式</th>
<th>抛出异常</th>
<th>返回特殊值</th>
<th>一直阻塞</th>
<th>超时退出</th>
</tr>
</thead>
<tbody>
<tr>
<td>插入方法</td>
<td>add(e)</td>
<td>offer(e)</td>
<td>put(e)</td>
<td>offer(e,time,unit)</td>
</tr>
<tr>
<td>移除方法</td>
<td>remove()</td>
<td>poll()</td>
<td>take()</td>
<td>poll(time,unit)</td>
</tr>
<tr>
<td>检查方法</td>
<td>element()</td>
<td>peek()</td>
<td>不可用</td>
<td>不可用</td>
</tr>
</tbody>
</table>
<ul>
<li>抛出异常：是指当阻塞队列满时候，再往队列里插入元素，会抛出IllegalStateException(“Queue full”)异常。当队列为空时，从队列里获取元素时会抛出NoSuchElementException异常 。</li>
<li>返回特殊值：插入方法会返回是否成功，成功则返回true。移除方法，则是从队列里拿出一个元素，如果没有则返回null</li>
<li>一直阻塞：当阻塞队列满时，如果生产者线程往队列里put元素，队列会一直阻塞生产者线程，直到拿到数据，或者响应中断退出。当队列空时，消费者线程试图从队列里take元素，队列也会阻塞消费者线程，直到队列可用。</li>
<li>超时退出：当阻塞队列满时，队列会阻塞生产者线程一段时间，如果超过一定的时间，生产者线程就会退出。</li>
</ul>
<h3 id="原理简单介绍"><a href="#原理简单介绍" class="headerlink" title="原理简单介绍"></a>原理简单介绍</h3><p>如果队列是空的，消费者会一直等待，当生产者添加元素时候，消费者是如何知道当前队列有元素的呢？如果让你来设计阻塞队列你会如何设计，让生产者和消费者能够高效率的进行通讯呢？让我们先来看看JDK是如何实现的。</p>
<p>使用通知模式实现。所谓通知模式，就是当生产者往满的队列里添加元素时会阻塞住生产者，当消费者消费了一个队列中的元素后，会通知生产者当前队列可用。通过查看JDK源码发现ArrayBlockingQueue使用了Condition来实现，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notFull;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition notEmpty;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> fair)</span> </span>&#123;</div><div class="line">        <span class="comment">//省略其他代码</span></div><div class="line">        notEmpty = lock.newCondition();</div><div class="line">        notFull =  lock.newCondition();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        checkNotNull(e);</div><div class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">        lock.lockInterruptibly();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (count == items.length)</div><div class="line">                notFull.await();</div><div class="line">            insert(e);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock;</div><div class="line">        lock.lockInterruptibly();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">while</span> (count == <span class="number">0</span>)</div><div class="line">                notEmpty.await();</div><div class="line">            <span class="keyword">return</span> extract();</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            lock.unlock();</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">(E x)</span> </span>&#123;</div><div class="line">        items[putIndex] = x;</div><div class="line">        putIndex = inc(putIndex);</div><div class="line">        ++count;</div><div class="line">        notEmpty.signal();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>整个原理框架如上所示，深入的原理在本文中不做进一步挖掘</p>
<h3 id="ArrayBlockingQueue-vs-LinkedBlockingQueue"><a href="#ArrayBlockingQueue-vs-LinkedBlockingQueue" class="headerlink" title="ArrayBlockingQueue vs LinkedBlockingQueue"></a>ArrayBlockingQueue vs LinkedBlockingQueue</h3><ul>
<li>ArrayBlockingQueue ：一个由数组结构组成的有界阻塞队列。</li>
</ul>
<p>ArrayBlockingQueue的大小在创建之后就不会改变。如果设置大小为Integer.MAX_VALUE在内存中会是一个很大的开销</p>
<ul>
<li>LinkedBlockingQueue ：一个由链表结构组成的有界阻塞队列。</li>
</ul>
<p>动态的创建节点，知道达到上限 默认上限是Integer.MAX_VALUE</p>
<h3 id="使用demo"><a href="#使用demo" class="headerlink" title="使用demo"></a>使用demo</h3><p>生产者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.concurrent.blockingqueue;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">	<span class="keyword">protected</span> BlockingQueue queue = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(BlockingQueue queue)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.queue = queue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            queue.put(<span class="string">"1"</span>);</div><div class="line">            Thread.sleep(<span class="number">1000</span>);</div><div class="line">            queue.put(<span class="string">"2"</span>);</div><div class="line">            Thread.sleep(<span class="number">1000</span>);</div><div class="line">            queue.put(<span class="string">"3"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>消费者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.concurrent.blockingqueue;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">	<span class="keyword">protected</span> BlockingQueue queue = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(BlockingQueue queue)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.queue = queue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(queue.take());</div><div class="line">            System.out.println(queue.take());</div><div class="line">            System.out.println(queue.take());</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行demo<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.concurrent.blockingqueue;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.BlockingQueue;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BlockingQueueTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">		BlockingQueue queue = <span class="keyword">new</span> ArrayBlockingQueue(<span class="number">1024</span>);</div><div class="line"></div><div class="line">		Producer producer = <span class="keyword">new</span> Producer(queue);</div><div class="line">		Consumer consumer = <span class="keyword">new</span> Consumer(queue);</div><div class="line"></div><div class="line">		<span class="keyword">new</span> Thread(producer).start();</div><div class="line">		<span class="keyword">new</span> Thread(consumer).start();</div><div class="line"></div><div class="line">		Thread.sleep(<span class="number">4000</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>测试结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td></tr></table></figure></p>
<p>1,2,3出现的时间间隔是1秒钟</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;BlockingQueue的使用&quot;&gt;&lt;a href=&quot;#BlockingQueue的使用&quot; class=&quot;headerlink&quot; title=&quot;BlockingQueue的使用&quot;&gt;&lt;/a&gt;BlockingQueue的使用&lt;/h2&gt;&lt;h3 id=&quot;基础概念&quot;&gt;&lt;a 
    
    </summary>
    
      <category term="多线程" scheme="http://yoursite.com/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
    
      <category term="多线程" scheme="http://yoursite.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>java异常的简单使用</title>
    <link href="http://yoursite.com/2016/12/22/java%E5%BC%82%E5%B8%B8%E4%BD%BF%E7%94%A8%E8%AF%AF%E5%8C%BA/"/>
    <id>http://yoursite.com/2016/12/22/java异常使用误区/</id>
    <published>2016-12-22T14:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.078Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0-背景介绍"><a href="#0-背景介绍" class="headerlink" title="0. 背景介绍"></a>0. 背景介绍</h2><p>异常处理是代码中必不可少的处理部分，如何正确的处理异常时非常关键的，为了以后代码中异常处理的规范性，搜罗了一些异常使用的建议，供以后使用</p>
<h2 id="1-异常分类"><a href="#1-异常分类" class="headerlink" title="1.异常分类"></a>1.异常分类</h2><p>大体上可以将异常分为两类</p>
<ol>
<li>调用代码不能继续执行，需要立即终止。例如服务器连接不上、参数不正确等。这些时候都适用非检测异常，不需要调用代码的显式捕捉和处理，而且代码简洁明了。</li>
<li>调用代码需要进一步处理和恢复。如SQL异常等等</li>
</ol>
<h2 id="2-异常处理的常用方式"><a href="#2-异常处理的常用方式" class="headerlink" title="2. 异常处理的常用方式"></a>2. 异常处理的常用方式</h2><h3 id="2-1-自定义错误返回码"><a href="#2-1-自定义错误返回码" class="headerlink" title="2.1 自定义错误返回码"></a>2.1 自定义错误返回码</h3><p>这样处理之后异常信息简洁明了，而且容易定位错误发生的原因。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 自定义 RuntimeException</div><div class="line"> * 添加错误代码属性</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeException</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">RuntimeException</span> </span>&#123;</div><div class="line">     <span class="comment">//默认错误代码</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer GENERIC = <span class="number">1000000</span>;</div><div class="line">    <span class="comment">//错误代码</span></div><div class="line">    <span class="keyword">private</span> Integer errorCode;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="title">RuntimeException</span><span class="params">(Integer errorCode, Throwable cause)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>(errorCode, <span class="keyword">null</span>, cause);</div><div class="line">     &#125;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="title">RuntimeException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</div><div class="line">            <span class="comment">//利用通用错误代码</span></div><div class="line">            <span class="keyword">this</span>(GENERIC, message, cause);</div><div class="line">     &#125;</div><div class="line">     <span class="function"><span class="keyword">public</span> <span class="title">RuntimeException</span><span class="params">(Integer errorCode, String message, Throwable cause)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(message, cause);</div><div class="line">            <span class="keyword">this</span>.errorCode = errorCode;</div><div class="line">     &#125;</div><div class="line">     <span class="function"><span class="keyword">public</span> Integer <span class="title">getErrorCode</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> errorCode;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-2-及时捕获异常"><a href="#2-2-及时捕获异常" class="headerlink" title="2.2. 及时捕获异常"></a>2.2. 及时捕获异常</h3><p>异常要及时捕获，代码分层次，异常及时捕获，以免污染层次，比如我们连接数据库时，出现异常，如果此时抛出异常的话，那么时候这个异常就会在代码的各个角落里出现，看着就不舒服<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Customer <span class="title">retrieveCustomerById</span><span class="params">(Long id)</span> </span>&#123;</div><div class="line">     <span class="keyword">try</span>&#123;</div><div class="line">            <span class="comment">//根据 ID 查询数据库</span></div><div class="line">     &#125;<span class="keyword">catch</span>(SQLException e)&#123;</div><div class="line">            <span class="comment">//利用非检测异常封装检测异常，降低层次耦合</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(SQLErrorCode, e);</div><div class="line">     &#125;<span class="keyword">finally</span>&#123;</div><div class="line">            <span class="comment">//关闭连接，清理资源</span></div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-3-不要忽略异常"><a href="#2-3-不要忽略异常" class="headerlink" title="2.3. 不要忽略异常"></a>2.3. 不要忽略异常</h3><p>如下异常处理只是将异常输出到控制台，没有任何意义。而且这里出现了异常并没有中断程序，进而调用代码继续执行，导致更多的异常。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retrieveObjectById</span><span class="params">(Long id)</span></span>&#123;</div><div class="line">   <span class="keyword">try</span>&#123;</div><div class="line">       <span class="comment">//..some code that throws SQLException</span></div><div class="line">    &#125;<span class="keyword">catch</span>(SQLException ex)&#123;</div><div class="line">     <span class="comment">/**</span></div><div class="line">       *了解的人都知道，这里的异常打印毫无意义，仅仅是将错误堆栈输出到控制台。</div><div class="line">       * 而在 Production 环境中，需要将错误堆栈输出到日志。</div><div class="line">       * 而且这里 catch 处理之后程序继续执行，会导致进一步的问题*/</div><div class="line"></div><div class="line">          ex.printStacktrace();</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以将代码重构成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">retrieveObjectById</span><span class="params">(Long id)</span></span>&#123;</div><div class="line"> <span class="keyword">try</span>&#123;</div><div class="line">    <span class="comment">//..some code that throws SQLException</span></div><div class="line"> &#125;</div><div class="line"> <span class="keyword">catch</span>(SQLException ex)&#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(“Exception in retieveObjectById”, ex);</div><div class="line"> &#125;</div><div class="line"> <span class="keyword">finally</span>&#123;</div><div class="line">    <span class="comment">//clean up resultset, statement, connection etc</span></div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;0-背景介绍&quot;&gt;&lt;a href=&quot;#0-背景介绍&quot; class=&quot;headerlink&quot; title=&quot;0. 背景介绍&quot;&gt;&lt;/a&gt;0. 背景介绍&lt;/h2&gt;&lt;p&gt;异常处理是代码中必不可少的处理部分，如何正确的处理异常时非常关键的，为了以后代码中异常处理的规范性，搜罗
    
    </summary>
    
      <category term="java基础" scheme="http://yoursite.com/categories/java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="java基础" scheme="http://yoursite.com/tags/java%E5%9F%BA%E7%A1%80/"/>
    
  </entry>
  
  <entry>
    <title>Guava使用基础入门-cache</title>
    <link href="http://yoursite.com/2016/12/21/guava%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8-cache/"/>
    <id>http://yoursite.com/2016/12/21/guava使用基础入门-cache/</id>
    <published>2016-12-21T13:58:10.000Z</published>
    <updated>2016-12-27T14:49:37.036Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Guava使用基础入门-cache"><a href="#Guava使用基础入门-cache" class="headerlink" title="Guava使用基础入门-cache"></a>Guava使用基础入门-cache</h2><h3 id="0-使用说明"><a href="#0-使用说明" class="headerlink" title="0. 使用说明"></a>0. 使用说明</h3><p>guava是Google的一个底层的库，里面包含了许多非常基础的应用，在很多Google的项目中都用到这个库，在平时项目的开发中，如果能善用这些方法，会使得我们的代码更加规范和健壮。</p>
<h3 id="1-Guava-Cache"><a href="#1-Guava-Cache" class="headerlink" title="1. Guava Cache"></a>1. Guava Cache</h3><p>通常来说，Guava Cache适用于：</p>
<ul>
<li>你愿意消耗一些内存空间来提升速度。</li>
<li>你预料到某些键会被查询一次以上。</li>
<li>缓存中存放的数据总量不会超出内存容量</li>
</ul>
<p>在使用缓存前，首先问自己一个问题：有没有合理的默认方法来加载或计算与键关联的值？如果有的话，你应当使用CacheLoader。如果没有，或者你想要覆盖默认的加载运算，同时保留”获取缓存-如果没有-则计算”[get-if-absent-compute]的原子语义，你应该在调用get时传入一个Callable实例。缓存元素也可以通过Cache.put方法直接插入，但自动加载是首选的，因为它可以更容易地推断所有缓存内容的一致性。</p>
<h3 id="2-使用demo"><a href="#2-使用demo" class="headerlink" title="2. 使用demo"></a>2. 使用demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.guava.cache;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.common.base.MoreObjects;</div><div class="line"><span class="keyword">import</span> com.google.common.cache.CacheBuilder;</div><div class="line"><span class="keyword">import</span> com.google.common.cache.CacheLoader;</div><div class="line"><span class="keyword">import</span> com.google.common.cache.LoadingCache;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheDemo</span> </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">		<span class="comment">// create a cache for employees based on their employee id</span></div><div class="line">		LoadingCache&lt;String, Employee&gt; employeeCache = CacheBuilder</div><div class="line">				.newBuilder().maximumSize(<span class="number">100</span>) <span class="comment">// maximum 100 records can be cached												</span></div><div class="line">				.expireAfterAccess(<span class="number">30</span>, TimeUnit.MINUTES) <span class="comment">// cache will expire after 30 minutes of access														</span></div><div class="line">				.build(<span class="keyword">new</span> CacheLoader&lt;String, Employee&gt;() &#123; <span class="comment">// build the cacheloader																</span></div><div class="line">					<span class="meta">@Override</span></div><div class="line">					<span class="function"><span class="keyword">public</span> Employee <span class="title">load</span><span class="params">(String empId)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">						<span class="comment">// make the expensive call</span></div><div class="line">						<span class="keyword">return</span> getFromDatabase(empId);</div><div class="line">					&#125;</div><div class="line">				&#125;);</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// on first invocation, cache will be populated with corresponding</span></div><div class="line">			<span class="comment">// employee record</span></div><div class="line">			System.out.println(<span class="string">"Invocation #1"</span>);</div><div class="line">			System.out.println(employeeCache.get(<span class="string">"100"</span>));</div><div class="line">			System.out.println(employeeCache.get(<span class="string">"103"</span>));</div><div class="line">			System.out.println(employeeCache.get(<span class="string">"110"</span>));</div><div class="line"></div><div class="line">			<span class="comment">// second invocation, data will be returned from cache</span></div><div class="line">			System.out.println(<span class="string">"Invocation #2"</span>);</div><div class="line">			System.out.println(employeeCache.get(<span class="string">"100"</span>));</div><div class="line">			System.out.println(employeeCache.get(<span class="string">"103"</span>));</div><div class="line">			System.out.println(employeeCache.get(<span class="string">"110"</span>));</div><div class="line"></div><div class="line">		&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Employee <span class="title">getFromDatabase</span><span class="params">(String empId)</span> </span>&#123;</div><div class="line"></div><div class="line">		Employee e1 = <span class="keyword">new</span> Employee(<span class="string">"Mahesh"</span>, <span class="string">"Finance"</span>, <span class="string">"100"</span>);</div><div class="line">		Employee e2 = <span class="keyword">new</span> Employee(<span class="string">"Rohan"</span>, <span class="string">"IT"</span>, <span class="string">"103"</span>);</div><div class="line">		Employee e3 = <span class="keyword">new</span> Employee(<span class="string">"Sohan"</span>, <span class="string">"Admin"</span>, <span class="string">"110"</span>);</div><div class="line"></div><div class="line">		Map&lt;String, Employee&gt; database = <span class="keyword">new</span> HashMap&lt;String, Employee&gt;();</div><div class="line"></div><div class="line">		database.put(<span class="string">"100"</span>, e1);</div><div class="line">		database.put(<span class="string">"103"</span>, e2);</div><div class="line">		database.put(<span class="string">"110"</span>, e3);</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"Database hit for"</span> + empId);</div><div class="line"></div><div class="line">		<span class="keyword">return</span> database.get(empId);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</div><div class="line">	String name;</div><div class="line">	String dept;</div><div class="line">	String emplD;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(String name, String dept, String empID)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.dept = dept;</div><div class="line">		<span class="keyword">this</span>.emplD = empID;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getDept</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> dept;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDept</span><span class="params">(String dept)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.dept = dept;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getEmplD</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> emplD;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEmplD</span><span class="params">(String emplD)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.emplD = emplD;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> MoreObjects.toStringHelper(Employee.class).add(<span class="string">"Name"</span>, name)</div><div class="line">				.add(<span class="string">"Department"</span>, dept).add(<span class="string">"Emp Id"</span>, emplD).toString();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>程序运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Invocation #1</div><div class="line">Database hit for100</div><div class="line">Employee&#123;Name=Mahesh, Department=Finance, Emp Id=100&#125;</div><div class="line">Database hit for103</div><div class="line">Employee&#123;Name=Rohan, Department=IT, Emp Id=103&#125;</div><div class="line">Database hit for110</div><div class="line">Employee&#123;Name=Sohan, Department=Admin, Emp Id=110&#125;</div><div class="line">Invocation #2</div><div class="line">Employee&#123;Name=Mahesh, Department=Finance, Emp Id=100&#125;</div><div class="line">Employee&#123;Name=Rohan, Department=IT, Emp Id=103&#125;</div><div class="line">Employee&#123;Name=Sohan, Department=Admin, Emp Id=110&#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Guava使用基础入门-cache&quot;&gt;&lt;a href=&quot;#Guava使用基础入门-cache&quot; class=&quot;headerlink&quot; title=&quot;Guava使用基础入门-cache&quot;&gt;&lt;/a&gt;Guava使用基础入门-cache&lt;/h2&gt;&lt;h3 id=&quot;0-使用说
    
    </summary>
    
      <category term="guava" scheme="http://yoursite.com/categories/guava/"/>
    
      <category term="java" scheme="http://yoursite.com/categories/guava/java/"/>
    
    
      <category term="guava" scheme="http://yoursite.com/tags/guava/"/>
    
      <category term="java" scheme="http://yoursite.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>Guava使用基础入门-cache(2)</title>
    <link href="http://yoursite.com/2016/12/21/Guava%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8-cache(2)/"/>
    <id>http://yoursite.com/2016/12/21/Guava使用基础入门-cache(2)/</id>
    <published>2016-12-21T13:58:10.000Z</published>
    <updated>2016-12-27T14:49:37.033Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0-背景"><a href="#0-背景" class="headerlink" title="0. 背景"></a>0. 背景</h3><p>昨天晚上思考的guava cache做性能优化的问题，今天就简单进行试验了一下，记录一下，以后在具体问题具体分析做进一步的优化，</p>
<h3 id="1-使用demo介绍"><a href="#1-使用demo介绍" class="headerlink" title="1. 使用demo介绍"></a>1. 使用demo介绍</h3><p>以限制IP访问为例，比如限制某个IP的访问次数或者。某个IP在5秒钟只能访问一次<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.isoldier.guava.cache;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.concurrent.ExecutionException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.google.common.cache.CacheBuilder;</div><div class="line"><span class="keyword">import</span> com.google.common.cache.CacheLoader;</div><div class="line"><span class="keyword">import</span> com.google.common.cache.LoadingCache;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 访问次数限制，限制多长时间访问一次</div><div class="line"> * <span class="doctag">@author</span> isoldier</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheManual</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line"></div><div class="line">		LoadingCache&lt;String, Boolean&gt; isCached = CacheBuilder.newBuilder()</div><div class="line">				.maximumSize(<span class="number">100</span>).expireAfterAccess(<span class="number">5</span>, TimeUnit.SECONDS)</div><div class="line">				.build(<span class="keyword">new</span> CacheLoader&lt;String, Boolean&gt;() &#123;</div><div class="line">					<span class="meta">@Override</span></div><div class="line">					<span class="function"><span class="keyword">public</span> Boolean <span class="title">load</span><span class="params">(String IP)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">						<span class="comment">// make the expensive call</span></div><div class="line">						System.out.println(<span class="string">"make the expensive call "</span>);</div><div class="line"></div><div class="line">						<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">// on first invocation, cache will be populated with corresponding</span></div><div class="line">			<span class="comment">// employee record</span></div><div class="line">			String ip = <span class="string">"192.168.24.110"</span>;</div><div class="line">			System.out.println(<span class="string">"Invocation #1"</span>);</div><div class="line">			System.out.println(isCached.get(ip));</div><div class="line">			<span class="keyword">if</span> (!isCached.get(ip)) &#123;</div><div class="line">				isCached.put(ip, <span class="keyword">true</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			Thread.sleep(<span class="number">6</span>*<span class="number">1000</span>);</div><div class="line">			<span class="comment">//</span></div><div class="line">			System.out.println(<span class="string">"Invocation #2"</span>);</div><div class="line">			System.out.println(isCached.get(ip));</div><div class="line"></div><div class="line"></div><div class="line">			<span class="keyword">if</span>(isCached.get(ip))&#123;</div><div class="line">				System.out.println(<span class="string">"访问次数超限 "</span>);</div><div class="line">			&#125;<span class="keyword">else</span>&#123;</div><div class="line">				System.out.println(<span class="string">"访问正常"</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>运行结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Invocation #1</div><div class="line">make the expensive call</div><div class="line">false</div><div class="line">Invocation #2</div><div class="line">make the expensive call</div><div class="line">false</div><div class="line">访问正常</div></pre></td></tr></table></figure></p>
<p>注释掉Thread.sleep(6*1000);运行结果如下<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Invocation #1</div><div class="line">make the expensive call</div><div class="line">false</div><div class="line">Invocation #2</div><div class="line">true</div><div class="line">访问次数超限</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;0-背景&quot;&gt;&lt;a href=&quot;#0-背景&quot; class=&quot;headerlink&quot; title=&quot;0. 背景&quot;&gt;&lt;/a&gt;0. 背景&lt;/h3&gt;&lt;p&gt;昨天晚上思考的guava cache做性能优化的问题，今天就简单进行试验了一下，记录一下，以后在具体问题具体分析做进一步
    
    </summary>
    
      <category term="guava" scheme="http://yoursite.com/categories/guava/"/>
    
      <category term="java" scheme="http://yoursite.com/categories/guava/java/"/>
    
    
      <category term="guava" scheme="http://yoursite.com/tags/guava/"/>
    
      <category term="java" scheme="http://yoursite.com/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>maven常用操作</title>
    <link href="http://yoursite.com/2016/12/16/maven%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/"/>
    <id>http://yoursite.com/2016/12/16/maven常用操作/</id>
    <published>2016-12-16T14:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.096Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-创建maven项目"><a href="#1-创建maven项目" class="headerlink" title="1. 创建maven项目"></a>1. 创建maven项目</h2><p>普通项目<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn archetype:generate -DgroupId=com.ect -DartifactId=log4jDemo -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false -DarchetypeCatalog=internal</div></pre></td></tr></table></figure></p>
<p>web项目<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn archetype:generate -DgroupId=com.ect -DartifactId=edhConsumer -DarchetypeArtifactId=maven-archetype-webapp -DinteractiveMode=false -DarchetypeCatalog=internal</div></pre></td></tr></table></figure></p>
<p>创建完成后<br>mvn eclipse:eclipse<br>然后用eclipse 导入已存在的maven project</p>
<h2 id="2-maven项目的classpath问题"><a href="#2-maven项目的classpath问题" class="headerlink" title="2. maven项目的classpath问题"></a>2. maven项目的classpath问题</h2><p>当eclipse的工程中找不到maven dependency 的包时，可以在.classpath 文件中增加如下<br>普通项目<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">      <span class="tag">&lt;<span class="name">classpathentry</span> <span class="attr">kind</span>=<span class="string">"con"</span> <span class="attr">path</span>=<span class="string">"org.eclipse.m2e.MAVEN2_CLASSPATH_CONTAINER"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">attributes</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"maven.pomderived"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"org.eclipse.jst.component.nondependency"</span> <span class="attr">value</span>=<span class="string">""</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">attributes</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">classpathentry</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>web工程<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">      <span class="tag">&lt;<span class="name">classpathentry</span> <span class="attr">kind</span>=<span class="string">"con"</span> <span class="attr">path</span>=<span class="string">"org.eclipse.m2e.MAVEN2_CLASSPATH_CONTAINER"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">attributes</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"maven.pomderived"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">"org.eclipse.jst.component.dependency"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/lib"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">attributes</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">classpathentry</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="3-清理lastUpdated文件命令"><a href="#3-清理lastUpdated文件命令" class="headerlink" title="3. 清理lastUpdated文件命令"></a>3. 清理lastUpdated文件命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">find -name \*.lastUpdated -exec rm -fv &#123;&#125; +</div></pre></td></tr></table></figure>
<h2 id="4-下载源码包"><a href="#4-下载源码包" class="headerlink" title="4. 下载源码包"></a>4. 下载源码包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn dependency:sources -DdownloadSources=true</div></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-创建maven项目&quot;&gt;&lt;a href=&quot;#1-创建maven项目&quot; class=&quot;headerlink&quot; title=&quot;1. 创建maven项目&quot;&gt;&lt;/a&gt;1. 创建maven项目&lt;/h2&gt;&lt;p&gt;普通项目&lt;br&gt;&lt;figure class=&quot;highlight
    
    </summary>
    
      <category term="maven" scheme="http://yoursite.com/categories/maven/"/>
    
    
      <category term="maven" scheme="http://yoursite.com/tags/maven/"/>
    
  </entry>
  
  <entry>
    <title>ExecutorService的使用</title>
    <link href="http://yoursite.com/2016/12/16/ExecutorService%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://yoursite.com/2016/12/16/ExecutorService的使用/</id>
    <published>2016-12-16T03:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.022Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ExecutorService的使用"><a href="#ExecutorService的使用" class="headerlink" title="ExecutorService的使用"></a>ExecutorService的使用</h1><h3 id="1-创建ExecutorService的方式"><a href="#1-创建ExecutorService的方式" class="headerlink" title="1. 创建ExecutorService的方式"></a>1. 创建ExecutorService的方式</h3><p>创建ExecutorService的方式有好几种采用哪种方式创建应该依赖于具体的情况，我们也可以通过工厂模式创建ExecutorService，下面是三种常见的创建ExecutorService的方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ExecutorService executorService1 = Executors.newSingleThreadExecutor();</div><div class="line"></div><div class="line">ExecutorService executorService2 = Executors.newFixedThreadPool(<span class="number">10</span>);</div><div class="line"></div><div class="line">ExecutorService executorService3 = Executors.newScheduledThreadPool(<span class="number">10</span>);</div></pre></td></tr></table></figure>
<h3 id="2-使用ExecutorService的方式"><a href="#2-使用ExecutorService的方式" class="headerlink" title="2. 使用ExecutorService的方式"></a>2. 使用ExecutorService的方式</h3><p>以下是集中常见的使用方式<br>execute(Runnable)<br>submit(Runnable)<br>submit(Callable)<br>invokeAny(…)<br>invokeAll(…)</p>
<h4 id="execute-Runnable-使用demo"><a href="#execute-Runnable-使用demo" class="headerlink" title="execute(Runnable)使用demo"></a>execute(Runnable)使用demo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ExecutorService executorService = Executors.newSingleThreadExecutor();</div><div class="line"></div><div class="line">executorService.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Asynchronous task"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">executorService.shutdown();</div></pre></td></tr></table></figure>
<h4 id="submit-Runnable-使用demo"><a href="#submit-Runnable-使用demo" class="headerlink" title="submit(Runnable)使用demo"></a>submit(Runnable)使用demo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Future future = executorService.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Asynchronous task"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">future.get();  <span class="comment">//returns null if the task has finished correctly.</span></div></pre></td></tr></table></figure>
<h4 id="submit-Callable-使用demo"><a href="#submit-Callable-使用demo" class="headerlink" title="submit(Callable)使用demo"></a>submit(Callable)使用demo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Future future = executorService.submit(<span class="keyword">new</span> Callable()&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Asynchronous Callable"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="string">"Callable Result"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">System.out.println(<span class="string">"future.get() = "</span> + future.get());</div></pre></td></tr></table></figure>
<p>上述代码的执行结果为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Asynchronous Callable</div><div class="line">future.get() = Callable Result</div></pre></td></tr></table></figure></p>
<h4 id="invokeAny-…-使用demo"><a href="#invokeAny-…-使用demo" class="headerlink" title="invokeAny(…)使用demo"></a>invokeAny(…)使用demo</h4><p>该方法会唤醒其中任意一个线程去启动，如下的代码的输出的结果可能会出现Task1 也有可能是Task2 或者Task3  随机出现任意一个<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">ExecutorService executorService = Executors.newSingleThreadExecutor();</div><div class="line"></div><div class="line">Set&lt;Callable&lt;String&gt;&gt; callables = <span class="keyword">new</span> HashSet&lt;Callable&lt;String&gt;&gt;();</div><div class="line"></div><div class="line">callables.add(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Task 1"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">callables.add(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Task 2"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">callables.add(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Task 3"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">String result = executorService.invokeAny(callables);</div><div class="line"></div><div class="line">System.out.println(<span class="string">"result = "</span> + result);</div><div class="line"></div><div class="line">executorService.shutdown();</div></pre></td></tr></table></figure></p>
<h4 id="invokeAll-…-使用demo"><a href="#invokeAll-…-使用demo" class="headerlink" title="invokeAll(…)使用demo"></a>invokeAll(…)使用demo</h4><p>唤醒所有线程去执行<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">ExecutorService executorService = Executors.newSingleThreadExecutor();</div><div class="line"></div><div class="line">Set&lt;Callable&lt;String&gt;&gt; callables = <span class="keyword">new</span> HashSet&lt;Callable&lt;String&gt;&gt;();</div><div class="line"></div><div class="line">callables.add(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Task 1"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">callables.add(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Task 2"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line">callables.add(<span class="keyword">new</span> Callable&lt;String&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Task 3"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">List&lt;Future&lt;String&gt;&gt; futures = executorService.invokeAll(callables);</div><div class="line"></div><div class="line"><span class="keyword">for</span>(Future&lt;String&gt; future : futures)&#123;</div><div class="line">    System.out.println(<span class="string">"future.get = "</span> + future.get());</div><div class="line">&#125;</div><div class="line"></div><div class="line">executorService.shutdown();</div></pre></td></tr></table></figure></p>
<p>上述代码的执行结果是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">future.get = Task 1</div><div class="line">future.get = Task 3</div><div class="line">future.get = Task 2</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ExecutorService的使用&quot;&gt;&lt;a href=&quot;#ExecutorService的使用&quot; class=&quot;headerlink&quot; title=&quot;ExecutorService的使用&quot;&gt;&lt;/a&gt;ExecutorService的使用&lt;/h1&gt;&lt;h3 id=&quot;1
    
    </summary>
    
      <category term="多线程" scheme="http://yoursite.com/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
    
      <category term="多线程" scheme="http://yoursite.com/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>mysql查询优化入门</title>
    <link href="http://yoursite.com/2016/12/14/MySQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E5%8F%A5%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E5%8F%8A%E4%BC%98%E5%8C%96%E5%AE%9E%E4%BE%8B/"/>
    <id>http://yoursite.com/2016/12/14/MySQL查询语句执行顺序及优化实例/</id>
    <published>2016-12-14T14:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.113Z</updated>
    
    <content type="html"><![CDATA[<h2 id="1-mysql查询的基本查询顺序"><a href="#1-mysql查询的基本查询顺序" class="headerlink" title="1. mysql查询的基本查询顺序"></a>1. mysql查询的基本查询顺序</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(8) <span class="keyword">SELECT</span> (<span class="number">9</span>)</div><div class="line"><span class="keyword">DISTINCT</span> &lt;select_list&gt;</div><div class="line">(<span class="number">1</span>) <span class="keyword">FROM</span> &lt;left_table&gt;</div><div class="line">(<span class="number">3</span>) &lt;<span class="keyword">join</span> <span class="keyword">type</span>&gt; <span class="keyword">JOIN</span> &lt;right_table&gt;</div><div class="line">(<span class="number">2</span>) <span class="keyword">ON</span> &lt;join_condition&gt;</div><div class="line">(<span class="number">4</span>) <span class="keyword">WHERE</span> &lt;where_condition&gt;</div><div class="line">(<span class="number">5</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> &lt;group_by_list&gt;</div><div class="line">(<span class="number">6</span>) <span class="keyword">WITH</span> &#123;<span class="keyword">CUBE</span> | <span class="keyword">ROLLUP</span>&#125;</div><div class="line">(<span class="number">7</span>) <span class="keyword">HAVING</span> &lt;having_condition&gt;</div><div class="line">(<span class="number">10</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> &lt;order_by_list&gt;</div><div class="line">(<span class="number">11</span>) <span class="keyword">LIMIT</span> &lt;limit_number&gt;</div></pre></td></tr></table></figure>
<h2 id="2-例子"><a href="#2-例子" class="headerlink" title="2. 例子"></a>2. 例子</h2><p>例子是从网上找的，以便自己更好的理解</p>
<h3 id="2-1首先建立三张表"><a href="#2-1首先建立三张表" class="headerlink" title="2.1首先建立三张表"></a>2.1首先建立三张表</h3><p>课程表：数据100条</p>
<p>create table Course(<br>c_id int PRIMARY KEY,<br>name varchar(10)<br>);</p>
<p>学生表：数据7000条</p>
<p>create table Student(<br>id int PRIMARY KEY,<br>name varchar(10)<br>)；</p>
<p>学生成绩表：数据70w</p>
<p>create table SC(<br>sc_id int PRIMARY KEY,<br>s_id int,<br>c_id int,<br>score int);</p>
<h3 id="2-2-优化过程"><a href="#2-2-优化过程" class="headerlink" title="2.2. 优化过程"></a>2.2. 优化过程</h3><p>查询目的：查找语文考100分的考生</p>
<ul>
<li>查询方法</li>
</ul>
<p>select s.* from Student s where s.s_id in (select s_id from SC sc where sc.c_id = 0 and sc.score = 100 )</p>
<p>耗时30248.271s</p>
<ul>
<li>优化一</li>
</ul>
<p>查看执行计划<br>EXPLAIN<br>select s.* from Student s where s.s_id in (select s_id from SC sc where sc.c_id = 0 and sc.score = 100 )；</p>
<p>发现没有用到索引，type全是ALL，那么首先想到的就是建立一个索引，建立索引的字段当然是在where条件的字段。先给sc表的c_id和score建个索引<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">index</span> sc_c_id_index <span class="keyword">on</span> SC(c_id);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">index</span> sc_score_index <span class="keyword">on</span> SC(score);</div></pre></td></tr></table></figure></p>
<p>再次执行上述查询语句，时间为: 1.054s</p>
<p>快了3w多倍，大大缩短了查询时间，看来索引能极大程度的提高查询效率，建索引很有必要，很多时候都忘记建索引了，数据量小的的时候压根没感觉，这优化的感觉挺爽。</p>
<ul>
<li>优化二</li>
</ul>
<p>查询优化后的sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">EXPLAIN</span> <span class="keyword">EXTENDED</span></div><div class="line"><span class="keyword">select</span> s.* <span class="keyword">from</span> Student s <span class="keyword">where</span> s.s_id <span class="keyword">in</span> (<span class="keyword">select</span> s_id <span class="keyword">from</span> SC sc <span class="keyword">where</span> sc.c_id = <span class="number">0</span> <span class="keyword">and</span> sc.score = <span class="number">100</span> )；</div></pre></td></tr></table></figure></p>
<p>按照我之前的想法，该sql的执行的顺序应该是先执行子查询<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> s_id <span class="keyword">from</span> SC sc <span class="keyword">where</span> sc.c_id = <span class="number">0</span> <span class="keyword">and</span> sc.score = <span class="number">100</span>;</div></pre></td></tr></table></figure></p>
<p>耗时：0.001s</p>
<p>得到如下结果：<br>7 29 5000<br>然后再执行<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> s.* <span class="keyword">from</span> Student s <span class="keyword">where</span> s.s_id <span class="keyword">in</span>(<span class="number">7</span>,<span class="number">29</span>,<span class="number">5000</span>)</div></pre></td></tr></table></figure></p>
<p>耗时：0.001s</p>
<p>这样就是相当快了啊，Mysql竟然不是先执行里层的查询，而是将sql优化成了exists子句，并出现了EPENDENT SUBQUERY，<br>mysql是先执行外层查询，再执行里层的查询，这样就要循环70007*8次。<br>那么改用连接查询呢？<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> s.* <span class="keyword">from</span> Student sINNER <span class="keyword">JOIN</span> SC scon sc.s_id = s.s_idwhere sc.c_id=<span class="number">0</span> <span class="keyword">and</span> sc.score=<span class="number">100</span></div></pre></td></tr></table></figure></p>
<p>这里为了重新分析连接查询的情况，先暂时删除索引sc_c_id_index，sc_score_index<br>执行时间是：0.057s</p>
<h3 id="2-3-原文中还有进一步的优化策略，这里就不做进一步的记录了，等到遇到真实场景的时候再深入探索，"><a href="#2-3-原文中还有进一步的优化策略，这里就不做进一步的记录了，等到遇到真实场景的时候再深入探索，" class="headerlink" title="2.3. 原文中还有进一步的优化策略，这里就不做进一步的记录了，等到遇到真实场景的时候再深入探索，"></a>2.3. 原文中还有进一步的优化策略，这里就不做进一步的记录了，等到遇到真实场景的时候再深入探索，</h3>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;1-mysql查询的基本查询顺序&quot;&gt;&lt;a href=&quot;#1-mysql查询的基本查询顺序&quot; class=&quot;headerlink&quot; title=&quot;1. mysql查询的基本查询顺序&quot;&gt;&lt;/a&gt;1. mysql查询的基本查询顺序&lt;/h2&gt;&lt;figure class=&quot;
    
    </summary>
    
      <category term="mysql" scheme="http://yoursite.com/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql查询优化-使用索引</title>
    <link href="http://yoursite.com/2016/12/14/MySQL%E5%8D%95%E8%A1%A8%E7%99%BE%E4%B8%87%E6%95%B0%E6%8D%AE%E8%AE%B0%E5%BD%95%E5%88%86%E9%A1%B5%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <id>http://yoursite.com/2016/12/14/MySQL单表百万数据记录分页性能优化/</id>
    <published>2016-12-14T12:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.122Z</updated>
    
    <content type="html"><![CDATA[<h2 id="优化简单实例"><a href="#优化简单实例" class="headerlink" title="优化简单实例"></a>优化简单实例</h2><h3 id="在微信上看到的文章，简单记录了一下，以后可能会有所帮助。"><a href="#在微信上看到的文章，简单记录了一下，以后可能会有所帮助。" class="headerlink" title="在微信上看到的文章，简单记录了一下，以后可能会有所帮助。"></a>在微信上看到的文章，简单记录了一下，以后可能会有所帮助。</h3><h3 id="0-背景"><a href="#0-背景" class="headerlink" title="0. 背景"></a>0. 背景</h3><p>由于单表的数据记录高达了一百万条，造成数据访问很慢，Google分析的后台经常报告超时，尤其是页码大的页面更是慢的不行。</p>
<h3 id="1-测试表基本信息"><a href="#1-测试表基本信息" class="headerlink" title="1. 测试表基本信息"></a>1. 测试表基本信息</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> infomation_schema</div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">TABLES</span> <span class="keyword">WHERE</span> TABLE_SCHEMA = ‘dbname’ <span class="keyword">AND</span> TABLE_NAME = ‘product’</div></pre></td></tr></table></figure>
<p>查询结果可以看出</p>
<pre><code>关于行和表大小的单位都是字节，我们经过计算可以知道
平均行长度：大约5k
单表总大小：4.1g
表中字段各种类型都有varchar、datetime、text等，id字段为主键
</code></pre><h3 id="2-1-直接分页"><a href="#2-1-直接分页" class="headerlink" title="2.1. 直接分页"></a>2.1. 直接分页</h3><p>直接用limit start, count分页语句， 也是我程序中用的方法：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="keyword">start</span>, <span class="keyword">count</span></div></pre></td></tr></table></figure></p>
<p>当起始页较小时，查询没有性能问题，我们分别看下从10， 100， 1000， 10000开始分页的执行时间（每页取20条）， 如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">10</span>, <span class="number">20</span>   <span class="number">0.016</span>秒</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">100</span>, <span class="number">20</span>   <span class="number">0.016</span>秒</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">1000</span>, <span class="number">20</span>   <span class="number">0.047</span>秒</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">10000</span>, <span class="number">20</span>   <span class="number">0.094</span>秒</div></pre></td></tr></table></figure></p>
<p>我们已经看出随着起始记录的增加，时间也随着增大， 这说明分页语句limit跟起始页码是有很大关系的，那么我们把起始记录改为40w看下（也就是记录的一般左右）<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">400000</span>, <span class="number">20</span>   <span class="number">3.229</span>秒</div></pre></td></tr></table></figure></p>
<p>再看我们取最后一页记录的时间<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">866613</span>, <span class="number">20</span>   <span class="number">37.44</span>秒</div></pre></td></tr></table></figure></p>
<p>难怪搜索引擎抓取我们页面的时候经常会报超时，像这种分页最大的页码页显然这种时间是无法忍受的。</p>
<p>从中我们也能总结出两件事情：</p>
<ol>
<li>limit语句的查询时间与起始记录的位置成正比</li>
<li>mysql的limit语句是很方便，但是对记录很多的表并不适合直接使用。</li>
</ol>
<h3 id="2-2-优化-利用表的覆盖索引来加速分页查询"><a href="#2-2-优化-利用表的覆盖索引来加速分页查询" class="headerlink" title="2.2 优化-利用表的覆盖索引来加速分页查询"></a>2.2 优化-利用表的覆盖索引来加速分页查询</h3><p>我们都知道，利用了索引查询的语句中如果只包含了那个索引列（覆盖索引），那么这种情况会查询很快。</p>
<p>因为利用索引查找有优化算法，且数据就在查询索引上面，不用再去找相关的数据地址了，这样节省了很多时间。另外Mysql中也有相关的索引缓存，在并发高的时候利用缓存就效果更好了。</p>
<p>在我们的例子中，我们知道id字段是主键，自然就包含了默认的主键索引。现在让我们看看利用覆盖索引的查询效果如何：</p>
<p>这次我们之间查询最后一页的数据（利用覆盖索引，只包含id列），如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">866613</span>, <span class="number">20</span> <span class="number">0.2</span>秒</div></pre></td></tr></table></figure></p>
<p>相对于查询了所有列的37.44秒，提升了大概100多倍的速度</p>
<p>那么如果我们也要查询所有列，有两种方法，一种是id&gt;=的形式，另一种就是利用join，看下实际情况：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> product <span class="keyword">WHERE</span> <span class="keyword">ID</span> &gt; =(<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">866613</span>, <span class="number">1</span>) <span class="keyword">limit</span> <span class="number">20</span></div></pre></td></tr></table></figure></p>
<p>查询时间为0.2秒，简直是一个质的飞跃啊，哈哈</p>
<p>另一种写法<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> product a <span class="keyword">JOIN</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> product <span class="keyword">limit</span> <span class="number">866613</span>, <span class="number">20</span>) b <span class="keyword">ON</span> a.ID = b.id</div></pre></td></tr></table></figure></p>
<p>查询时间也很短，赞！</p>
<p>本文转载自<br><a href="http://www.cnblogs.com/lyroge/p/3837886.html" target="_blank" rel="external">http://www.cnblogs.com/lyroge/p/3837886.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;优化简单实例&quot;&gt;&lt;a href=&quot;#优化简单实例&quot; class=&quot;headerlink&quot; title=&quot;优化简单实例&quot;&gt;&lt;/a&gt;优化简单实例&lt;/h2&gt;&lt;h3 id=&quot;在微信上看到的文章，简单记录了一下，以后可能会有所帮助。&quot;&gt;&lt;a href=&quot;#在微信上看到的文章
    
    </summary>
    
      <category term="mysql" scheme="http://yoursite.com/categories/mysql/"/>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>iptables基础</title>
    <link href="http://yoursite.com/2016/11/25/iptables%E5%9F%BA%E7%A1%80/"/>
    <id>http://yoursite.com/2016/11/25/iptables基础/</id>
    <published>2016-11-25T15:06:19.000Z</published>
    <updated>2016-12-27T14:49:37.049Z</updated>
    
    <content type="html"><![CDATA[<h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>iptables是Linux内核默认的防火墙。防火墙，其实说白了讲，就是用于实现Linux下访问控制的功能的，它分为硬件的或者软件的防火墙两种。无论是在哪个网络中，防火墙工作的地方一定是在网络的边缘。而我们的任务就是需要去定义到底防火墙如何工作，这就是防火墙的策略，规则，以达到让它对出入网络的IP、数据进行检测。</p>
<p>对于TCP/IP的七层模型来讲，我们知道第三层是网络层，三层的防火墙会在这层对源地址和目标地址进行检测。</p>
<p>iptables在内核空间中的五个位置发生作用：</p>
<ol>
<li>内核空间中：从一个网络接口进来，到另一个网络接口去的</li>
<li>数据包从内核流入用户空间的</li>
<li>数据包从用户空间流出的</li>
<li>进入/离开本机的外网接口</li>
<li>进入/离开本机的内网接口</li>
</ol>
<p>这五个位置也被称为五个钩子函数（hook functions）,也叫五个规则链。</p>
<ol>
<li>PREROUTING (路由前)</li>
<li>INPUT (数据包流入口)</li>
<li>FORWARD (转发管卡)</li>
<li>OUTPUT(数据包出口)</li>
<li>POSTROUTING（路由后）</li>
</ol>
<h3 id="原理图"><a href="#原理图" class="headerlink" title="原理图"></a>原理图</h3><p><img src="http://ww2.sinaimg.cn/large/97be9d10gw1f6xsxzzupnj20b507pgm4.jpg" alt=""></p>
<h3 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h3><p><strong>格式：iptables [-t table] COMMAND chain CRETIRIA -j ACTION</strong></p>
<p>iptables [ -t 表名] 命令选项 [链名] [条件匹配] [-j 处理方式]<br>1、表名和链名即为上述四张表、5条链<br>2、常用的命令选项如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">-A    在指定链的末尾添加（--append）一条新的规则</div><div class="line">-I    在指定链中插入（--insert）一条新的规则，默认在链的开头插入</div><div class="line">-</div><div class="line">-D    删除（--delete）指定链中的某一条规则，按规则序号或内容确定要删除的规则</div><div class="line">-</div><div class="line">-L    列出（--list）指定链中的所有的规则进行查看，默认列出表中所有链的内容</div><div class="line">-F    清空（--flush）指定链中的所有规则，默认清空表中所有链的内容</div><div class="line">-</div><div class="line">-n    用数字形式（--numeric）显示输出结果，显示主机的 IP地址而不是主机名</div><div class="line">-</div><div class="line">-h    查看命令帮助信息（--help）</div></pre></td></tr></table></figure></p>
<p>3、条件匹配分为基本匹配和扩展匹配，常用的基本匹配参数如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">-p    指定规则协议，如tcp, udp,icmp等，可以使用all来指定所有协议</div><div class="line">-s    指定数据包的源地址参数，可以使IP地址、网络地址、主机名</div><div class="line">-d    指定目的地址</div><div class="line">-i    输入接口</div><div class="line">-o    输出接口</div></pre></td></tr></table></figure></p>
<p>4、常用的处理方式如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ACCEPT：允许数据包通过。</div><div class="line">DROP：直接丢弃数据包，不给出任何回应信息。</div><div class="line">REJECT：拒绝数据包通过，必须时会给数据发送端一个响应信息。</div></pre></td></tr></table></figure></p>
<p>\</p>
<h4 id="禁止客户机访问不健康网站"><a href="#禁止客户机访问不健康网站" class="headerlink" title="禁止客户机访问不健康网站"></a>禁止客户机访问不健康网站</h4><p>【例1】添加iptables规则禁止用户访问域名为www.sexy.com的网站。</p>
<p>iptables -I FORWARD -d www.sexy.com -j DROP</p>
<p>【例2】添加iptables规则禁止用户访问IP地址为20.20.20.20的网站。</p>
<p>iptables -I FORWARD -d 20.20.20.20 -j DROP</p>
<h4 id="禁止某些客户机上网"><a href="#禁止某些客户机上网" class="headerlink" title="禁止某些客户机上网"></a>禁止某些客户机上网</h4><p>【例1】添加iptables规则禁止IP地址为192.168.1.X的客户机上网。</p>
<p>iptables -I FORWARD -s 192.168.1.X -j DROP</p>
<p>【例2】添加iptables规则禁止192.168.1.0子网里所有的客户机上网。</p>
<p>iptables -I FORWARD -s 192.168.1.0/24 -j DROP</p>
<h4 id="禁止访问11-12-13-14地址"><a href="#禁止访问11-12-13-14地址" class="headerlink" title="禁止访问11.12.13.14地址"></a>禁止访问11.12.13.14地址</h4><p>iptables -A OUTPUT -d 11.12.13.14 -j DROP</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;iptables&quot;&gt;&lt;a href=&quot;#iptables&quot; class=&quot;headerlink&quot; title=&quot;iptables&quot;&gt;&lt;/a&gt;iptables&lt;/h2&gt;&lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; titl
    
    </summary>
    
      <category term="网络" scheme="http://yoursite.com/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
  </entry>
  
  <entry>
    <title>dubbo之addShutdownHook</title>
    <link href="http://yoursite.com/2016/11/19/dubbo%E4%B9%8BaddShutdownHook/"/>
    <id>http://yoursite.com/2016/11/19/dubbo之addShutdownHook/</id>
    <published>2016-11-19T13:46:17.000Z</published>
    <updated>2016-12-27T14:49:37.011Z</updated>
    
    <content type="html"><![CDATA[<h2 id="addShutdownHook-简单介绍"><a href="#addShutdownHook-简单介绍" class="headerlink" title="addShutdownHook 简单介绍"></a>addShutdownHook 简单介绍</h2><p>java.lang.Runtime.addShutdownHook(Thread hook) 方法注册一个新的虚拟机关闭挂钩。</p>
<p>该方法用来在jvm中增加一个关闭的钩子。当程序正常退出或者系统调用System.exit方法或虚拟机被关闭时就会执行添加的shutdownHook线程。<br>其中shutdownHook是一个已初始化但并不有启动的线程，当jvm关闭的时候，会执行系统中已经设置的所有通过方法addShutdownHook添加的钩子，当系统执行完这些钩子后，jvm才会关闭。所以可通过这些钩子在jvm关闭的时候进行内存清理、资源回收等工作</p>
<h3 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RuntimeDemo</span> </span>&#123;</div><div class="line"></div><div class="line">   <span class="comment">// a class that extends thread that is to be called when program is exiting</span></div><div class="line">   <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">         System.out.println(<span class="string">"Bye."</span>);</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">         <span class="comment">// register Message as shutdown hook</span></div><div class="line">         Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Message());</div><div class="line"></div><div class="line">         <span class="comment">// print the state of the program</span></div><div class="line">         System.out.println(<span class="string">"Program is starting..."</span>);</div><div class="line"></div><div class="line">         <span class="comment">// cause thread to sleep for 3 seconds</span></div><div class="line">         System.out.println(<span class="string">"Waiting for 3 seconds..."</span>);</div><div class="line">         Thread.sleep(<span class="number">3000</span>);</div><div class="line"></div><div class="line">         <span class="comment">// print that the program is closing </span></div><div class="line">         System.out.println(<span class="string">"Program is closing..."</span>);</div><div class="line"></div><div class="line"></div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">         e.printStackTrace();</div><div class="line">      &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Program is starting...</div><div class="line">Waiting for 3 seconds...</div><div class="line">Program is closing...</div><div class="line">Bye.</div></pre></td></tr></table></figure>
<h2 id="dubbo中使用的场景"><a href="#dubbo中使用的场景" class="headerlink" title="dubbo中使用的场景"></a>dubbo中使用的场景</h2><p>dubbo可以在非kill - 9或者发生故障时实现优雅退出<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">if</span> (args == <span class="keyword">null</span> || args.length == <span class="number">0</span>) &#123;</div><div class="line">              String config = ConfigUtils.getProperty(CONTAINER_KEY, loader.getDefaultExtensionName());</div><div class="line">              args = Constants.COMMA_SPLIT_PATTERN.split(config);</div><div class="line">          &#125;</div><div class="line">          </div><div class="line">          <span class="keyword">final</span> List&lt;Container&gt; containers = <span class="keyword">new</span> ArrayList&lt;Container&gt;();</div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i ++) &#123;</div><div class="line">              containers.add(loader.getExtension(args[i]));</div><div class="line">          &#125;</div><div class="line">          logger.info(<span class="string">"Use container type("</span> + Arrays.toString(args) + <span class="string">") to run dubbo serivce."</span>);</div><div class="line">          </div><div class="line">          <span class="keyword">if</span> (<span class="string">"true"</span>.equals(System.getProperty(SHUTDOWN_HOOK_KEY))) &#123;</div><div class="line">            Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">for</span> (Container container : containers) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            container.stop();</div><div class="line">                            logger.info(<span class="string">"Dubbo "</span> + container.getClass().getSimpleName() + <span class="string">" stopped!"</span>);</div><div class="line">                        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                            logger.error(t.getMessage(), t);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">synchronized</span> (Main.class) &#123;</div><div class="line">                            running = <span class="keyword">false</span>;</div><div class="line">                            Main.class.notify();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">          &#125;</div><div class="line">          </div><div class="line">          <span class="keyword">for</span> (Container container : containers) &#123;</div><div class="line">              container.start();</div><div class="line">              logger.info(<span class="string">"Dubbo "</span> + container.getClass().getSimpleName() + <span class="string">" started!"</span>);</div><div class="line">          &#125;</div><div class="line">          System.out.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"[yyyy-MM-dd HH:mm:ss]"</span>).format(<span class="keyword">new</span> Date()) + <span class="string">" Dubbo service server started!"</span>);</div><div class="line">      &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">          e.printStackTrace();</div><div class="line">          logger.error(e.getMessage(), e);</div><div class="line">          System.exit(<span class="number">1</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">synchronized</span> (Main.class) &#123;</div><div class="line">          <span class="keyword">while</span> (running) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                  Main.class.wait();</div><div class="line">              &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;addShutdownHook-简单介绍&quot;&gt;&lt;a href=&quot;#addShutdownHook-简单介绍&quot; class=&quot;headerlink&quot; title=&quot;addShutdownHook 简单介绍&quot;&gt;&lt;/a&gt;addShutdownHook 简单介绍&lt;/h2&gt;&lt;
    
    </summary>
    
      <category term="dubbo" scheme="http://yoursite.com/categories/dubbo/"/>
    
    
  </entry>
  
  <entry>
    <title>Vmware搭建集群</title>
    <link href="http://yoursite.com/2016/07/08/Vmware%E6%90%AD%E5%BB%BA%E9%9B%86%E7%BE%A4(%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83)/"/>
    <id>http://yoursite.com/2016/07/08/Vmware搭建集群(基础环境)/</id>
    <published>2016-07-07T16:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.136Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Vmware搭建集群（基础环境）"><a href="#Vmware搭建集群（基础环境）" class="headerlink" title="Vmware搭建集群（基础环境）"></a>Vmware搭建集群（基础环境）</h2><h3 id="1-单台机器配置"><a href="#1-单台机器配置" class="headerlink" title="1. 单台机器配置"></a>1. 单台机器配置</h3><h4 id="安装Vmware-tools"><a href="#安装Vmware-tools" class="headerlink" title="安装Vmware tools"></a>安装Vmware tools</h4><p>正常步骤安装虚拟机，以Ubuntu15.10为例，安装好之后会发现平面分辨率不够，并不能充满整个屏幕，安装VMware tools 安装好之后重启可以发现Ubuntu系统充满整个屏幕。</p>
<p>解压tools安装包文件夹<br>安装命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">tar -xvf VMwareTools-10.0.0-2977863.tar.gz</div><div class="line">cd vmware-tools-distrib/</div><div class="line">sudo ./vmware-install.pl</div></pre></td></tr></table></figure>
<p>按照屏幕提示安装执行</p>
<h4 id="安装openssh-server"><a href="#安装openssh-server" class="headerlink" title="安装openssh-server"></a>安装openssh-server</h4><p> 为了让外部机器可以通过ssh连接到该机器 需要安装ssh<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo apt-get install openssh-server</div></pre></td></tr></table></figure></p>
<h4 id="安装openssh-server-1"><a href="#安装openssh-server-1" class="headerlink" title="安装openssh-server"></a>安装openssh-server</h4><p>下载安装包 本文以安装包jdk-7u79-linux-x64.tar.gz为例，我们将jdk安装到/usr/lib/jvm 位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo mkdir /usr/lib/jvm</div><div class="line">cd /usr/lib/jvm/</div><div class="line">tar -xvf jdk-7u79-linux-x64.tar.gz</div></pre></td></tr></table></figure>
<p>修改环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim ~/.bashrc</div></pre></td></tr></table></figure></p>
<p>在文件末尾处添加以下内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#set oracle jdk environment</div><div class="line">export JAVA_HOME=/usr/lib/jvm/jdk1.7.0_79  ## 这里要注意目录要换成自己解压的jdk 目录</div><div class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</div><div class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/lib</div><div class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$PATH</div></pre></td></tr></table></figure></p>
<h3 id="2-集群配置"><a href="#2-集群配置" class="headerlink" title="2. 集群配置"></a>2. 集群配置</h3><h4 id="设置静态IP"><a href="#设置静态IP" class="headerlink" title="设置静态IP"></a>设置静态IP</h4><p>默认安装的Ubuntu系统网络配置是动态的自动获取IP地址，如果集群中的IP一直在变肯定是不行的，所以需要静态设置IP</p>
<ol>
<li>首先设置虚拟机的网络连接方式为NAT</li>
</ol>
<p><img src="http://ww4.sinaimg.cn/large/97be9d10gw1f5guykvfurj209y0bzgmg.jpg" alt=""></p>
<ol>
<li>以无线网络连接为例，在本机设置共享，选择VMnet8</li>
</ol>
<p><img src="http://ww4.sinaimg.cn/large/97be9d10gw1f5gv1z5eskj20bs0gomyb.jpg" alt=""></p>
<ol>
<li>查看VMnet8属性</li>
</ol>
<p><img src="http://ww1.sinaimg.cn/large/97be9d10gw1f5gv3v6gwbj20ol0gcwjn.jpg" alt=""><br>如果我们不设置静态ip的话，我们虚拟机的机器会随机分配192.168.24.3~192.168.24.254 之间的地址，其中涉及到网关，广播地址等网络知识，此处不作详细说明</p>
<ol>
<li>vmware 设置</li>
</ol>
<p>编辑-&gt;虚拟网络编辑器<br><img src="http://ww4.sinaimg.cn/large/97be9d10gw1f5gvq8c1z5j20uj0ex0wx.jpg" alt=""></p>
<ol>
<li>修改配置文件设置静态ip</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo vim /etc/network/interfaces</div></pre></td></tr></table></figure>
<p>修改配置文件为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># interfaces(5) file used by ifup(8) and ifdown(8)</div><div class="line">auto lo</div><div class="line">iface lo inet loopback</div><div class="line"></div><div class="line">auto eno16777736</div><div class="line">iface eno16777736 inet static</div><div class="line">address 192.168.24.111</div><div class="line">netmask 255.255.255.0</div><div class="line">gateway 192.168.24.2</div><div class="line">dns-nameservers 192.168.24.2</div></pre></td></tr></table></figure>
<p>代码中的eno16777736是用VMware安装后出现的结果，等价于eth0,具体原因不在本次讨论范围</p>
<p>使配置文件生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo  /etc/init.d/networking restart</div></pre></td></tr></table></figure>
<p>查看网络</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">jinmeng@ubuntu-slave1:/usr/lib/jvm$ ifconfig</div><div class="line">eno16777736 Link encap:Ethernet  HWaddr 00:0c:29:11:9d:cf</div><div class="line">          inet addr:192.168.24.111  Bcast:192.168.24.255  Mask:255.255.255.0</div><div class="line">          inet6 addr: fe80::20c:29ff:fe11:9dcf/64 Scope:Link</div><div class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</div><div class="line">          RX packets:879 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:652 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:1000</div><div class="line">          RX bytes:89405 (89.4 KB)  TX bytes:75163 (75.1 KB)</div><div class="line"></div><div class="line">lo        Link encap:Local Loopback</div><div class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</div><div class="line">          inet6 addr: ::1/128 Scope:Host</div><div class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</div><div class="line">          RX packets:208 errors:0 dropped:0 overruns:0 frame:0</div><div class="line">          TX packets:208 errors:0 dropped:0 overruns:0 carrier:0</div><div class="line">          collisions:0 txqueuelen:0</div><div class="line">          RX bytes:19171 (19.1 KB)  TX bytes:19171 (19.1 KB)</div></pre></td></tr></table></figure>
<p>如果不能够查看后ip不生效，重启虚拟机重新查看。</p>
<h4 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h4><ul>
<li>本机的无密码登录</li>
</ul>
<p>在每台虚拟机上分别执行以下命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh-keygen -t rsa -P &quot;&quot;</div><div class="line">cat $HOME/.ssh/id_rsa.pub &gt;&gt; $HOME/.ssh/authorized_keys</div></pre></td></tr></table></figure>
<p>执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ssh localhost</div></pre></td></tr></table></figure></p>
<p>可以发现此时无需输入密码</p>
<ul>
<li>集群之间的无密码ssh 通信</li>
</ul>
<p>以192.168.24.110/111/112 三台机为例</p>
<p>登录192.168.24.110<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh-copy-id -i $HOME/.ssh/id_rsa.pub username@192.168.24.111</div><div class="line">ssh-copy-id -i $HOME/.ssh/id_rsa.pub username@192.168.24.112</div></pre></td></tr></table></figure></p>
<p>这样之后110 就可以无密码登录111 和112 两台机器，<br>同理设置另外两台机</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Vmware搭建集群（基础环境）&quot;&gt;&lt;a href=&quot;#Vmware搭建集群（基础环境）&quot; class=&quot;headerlink&quot; title=&quot;Vmware搭建集群（基础环境）&quot;&gt;&lt;/a&gt;Vmware搭建集群（基础环境）&lt;/h2&gt;&lt;h3 id=&quot;1-单台机器配置&quot;
    
    </summary>
    
      <category term="大数据" scheme="http://yoursite.com/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="VMware" scheme="http://yoursite.com/tags/VMware/"/>
    
  </entry>
  
  <entry>
    <title>I love you</title>
    <link href="http://yoursite.com/2016/05/19/I-love-you/"/>
    <id>http://yoursite.com/2016/05/19/I-love-you/</id>
    <published>2016-05-18T16:43:03.000Z</published>
    <updated>2016-12-27T14:49:37.042Z</updated>
    
    <content type="html"><![CDATA[<h2 id="芝麻的文章"><a href="#芝麻的文章" class="headerlink" title="芝麻的文章"></a>芝麻的文章</h2><p>想和你一起坐火车去远行，<br>看着窗外陌生的风景慢悠悠的过，<br>还会有阳光斜斜的洒在你发间，<br>映着侧脸。</p>
<p>想和你并肩散步在昏黄的路灯下，<br>看着影子被灯光拉扯的佝偻又挺拔，<br>好像几步已一生，<br>光阴蔓延。</p>
<p>想和你躺在草地上一起看星星，<br>即使苍穹无边，也不用艳羡，<br>因为你已经是我的，<br>天地人间。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;芝麻的文章&quot;&gt;&lt;a href=&quot;#芝麻的文章&quot; class=&quot;headerlink&quot; title=&quot;芝麻的文章&quot;&gt;&lt;/a&gt;芝麻的文章&lt;/h2&gt;&lt;p&gt;想和你一起坐火车去远行，&lt;br&gt;看着窗外陌生的风景慢悠悠的过，&lt;br&gt;还会有阳光斜斜的洒在你发间，&lt;br&gt;映着侧脸。
    
    </summary>
    
      <category term="love" scheme="http://yoursite.com/categories/love/"/>
    
    
  </entry>
  
</feed>
